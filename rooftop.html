<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Rooftop Quiet Time</title>
  <style>
    :root{
      --bg1:#081525;
      --bg2:#0f2742;
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% -10%, rgba(255,255,255,0.08), transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      color: var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding: 18px 14px 28px;
    }
    .wrap{ width:min(760px, 100%); }
    h1{
      margin: 6px 0 8px;
      text-align:center;
      font-size: 34px;
      letter-spacing:-0.5px;
      line-height:1.05;
      font-weight: 800;
      text-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .sub{
      text-align:center;
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 12px;
    }

    .card{
      width:100%;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.16);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      padding: 16px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.35);
      position:relative;
      overflow:hidden;
    }
    canvas{
      width:100%;
      height:auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      display:block;
    }

    .panel{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      padding: 12px;
    }

    .typed{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color: rgba(255,255,255,0.92);
      font-size: 13px;
      line-height: 1.55;
      white-space: pre-wrap;
      min-height: 160px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    .btn{
      flex: 1 1 180px;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.95);
      font-weight: 800;
      font-size: 15px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 18px 48px rgba(0,0,0,0.25);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.disabled{
      opacity: 0.45;
      pointer-events:none;
    }

    .smallHint{
      margin-top: 8px;
      color: var(--muted2);
      font-size: 12px;
      text-align:center;
    }

    /* Mini-surprise popup */
    .popup{
      position:absolute;
      left: 50%;
      top: 18px;
      transform: translateX(-50%);
      width: min(560px, 92%);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      padding: 12px 14px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      z-index: 5;
    }
    .popup.show{ display:flex; }
    .popup .text{
      font-weight: 800;
      color: rgba(255,255,255,0.95);
      font-size: 14px;
    }
    .popup .go{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      font-weight: 900;
      cursor:pointer;
      white-space:nowrap;
    }

    /* Share confirmation modal */
    .modalBack{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.50);
      z-index: 10;
      padding: 16px;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width: min(560px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(10,18,30,0.92);
      box-shadow: 0 24px 70px rgba(0,0,0,0.55);
      padding: 14px;
    }
    .modal h3{
      margin: 0 0 6px;
      font-size: 16px;
      font-weight: 900;
    }
    .modal p{
      margin: 0 0 12px;
      font-size: 13px;
      color: rgba(255,255,255,0.72);
      line-height: 1.4;
    }
    .modalRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .modalBtn{
      flex: 1 1 170px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.95);
      font-weight: 900;
      font-size: 14px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .modalBtn.secondary{
      background: rgba(255,255,255,0.06);
      font-weight: 800;
      color: rgba(255,255,255,0.88);
    }
    .modalBtn.disabled{
      opacity: 0.45;
      pointer-events:none;
    }

    .hideControls .row,
    .hideControls #hint{
      display:none !important;
    }

    @media (max-width: 420px){
      h1{ font-size: 30px; }
      .typed{ font-size: 12px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Rooftop Quiet Time üåô</h1>
    <div class="sub">A calm moment ‚Äî record your reflection, then come back for a mini surprise.</div>

    <div class="card" id="card">
      <canvas id="scene" width="720" height="560"></canvas>

      <div class="popup" id="miniPopup">
        <div class="text">Here‚Äôs a mini surprise üå∏</div>
        <div class="go" id="miniGo">Open</div>
      </div>

      <div class="modalBack" id="shareModalBack">
        <div class="modal">
          <h3>Did you manage to send it on Telegram?</h3>
          <p>If Telegram didn‚Äôt attach it, tap ‚ÄúNo‚Äù and I‚Äôll help you download + retry.</p>
          <div class="modalRow" style="margin-bottom:10px;">
            <div class="modalBtn" id="modalYes">‚úÖ Yes ‚Üí mini surprise</div>
            <div class="modalBtn secondary" id="modalNo">‚ùå No ‚Üí download & retry</div>
          </div>
          <div class="modalRow">
            <div class="modalBtn secondary disabled" id="modalDownload">‚¨áÔ∏è Download audio</div>
            <div class="modalBtn secondary disabled" id="modalRetry">üîÅ Retry share</div>
          </div>
        </div>
      </div>

      <div class="panel" id="panel">
        <div class="typed" id="typed"></div>

        <div class="row">
          <div class="btn" id="recordBtn">üéôÔ∏è Record</div>
          <div class="btn disabled" id="sendBtn">üì§ Send to Sandra</div>
        </div>

        <div class="smallHint" id="hint">
          Tip: after you tap ‚ÄúSend to Sandra‚Äù, choose Telegram and send it to Sandra.
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("scene");
    const ctx = canvas.getContext("2d");

    const card = document.getElementById("card");
    const panel = document.getElementById("panel");

    const typedEl  = document.getElementById("typed");
    const recordBtn = document.getElementById("recordBtn");
    const sendBtn   = document.getElementById("sendBtn");
    const hintEl    = document.getElementById("hint");

    const miniPopup = document.getElementById("miniPopup");
    const miniGo = document.getElementById("miniGo");

    const shareModalBack = document.getElementById("shareModalBack");
    const modalYes = document.getElementById("modalYes");
    const modalNo = document.getElementById("modalNo");
    const modalDownload = document.getElementById("modalDownload");
    const modalRetry = document.getElementById("modalRetry");

    // Put bday.mp3 beside this file
    const bdayAudio = new Audio("bday.mp3");
    bdayAudio.preload = "auto";

    const SHARE_TEXT = "here‚Äôs my 30th rooftop reflection ü•π";

    const instructions =
`Follow these instructions carefully.

1. Think about these two questions:
A. Now that you‚Äôve turned 30, What would you tell your 21 year old self?
B. What is your 30 year old birthday wish for yourself?
2. Click on record to start recording your answers
3. Click on ‚ÄúSend to Sandra‚Äù
4. A pop up will appear, send it to Sandra through telegram
5. !Important! Come back to this screen for a mini surprise`;

    const surpriseLetter =
`Dear Gwen,

Happiest 30th birthday! May you be blessed with the kindest people, all the love in the world, and exciting adventures. I hope you enjoyed your 30th birthday wish of having an amazing race (virtually). Love you my favourite friend! You deserve nothing but the best.

With lots of love,
Sandra`;

    function tokenizeWords(text){
      const tokens = [];
      const lines = text.split("\n");
      for (let li=0; li<lines.length; li++){
        const line = lines[li];
        if (line.trim().length === 0){
          tokens.push({t:"\n"});
          continue;
        }
        const parts = line.split(" ");
        for (let i=0;i<parts.length;i++){
          const w = parts[i];
          tokens.push({t: (i===0 ? w : " " + w)});
        }
        if (li !== lines.length-1) tokens.push({t:"\n"});
      }
      return tokens;
    }

    let typeTimer = null;
    function typewrite(text){
      if (typeTimer) clearTimeout(typeTimer);
      typedEl.textContent = "";

      const tokens = tokenizeWords(text);
      let idx = 0;

      const tick = () => {
        if (idx >= tokens.length) return;
        typedEl.textContent += tokens[idx].t;

        const last = tokens[idx].t || "";
        idx++;

        let delay = 65;
        if (last.includes("\n")) delay = 220;
        if (/[.!?]$/.test(last.trim())) delay = 240;

        typeTimer = setTimeout(tick, delay);
      };
      tick();
    }

    typewrite(instructions);

    // -----------------------------
    // Recording
    // -----------------------------
    let mediaStream = null;
    let recorder = null;
    let chunks = [];
    let recordedBlob = null;
    let recordedFile = null;
    let isRecording = false;

    function setBtn(el, text, enabled){
      el.textContent = text;
      el.classList.toggle("disabled", !enabled);
    }

    function pickMimeType(){
      // iPhone Safari often supports audio/mp4 (m4a). Android/Chrome often supports webm/opus.
      const candidates = [
        "audio/mp4;codecs=mp4a.40.2",
        "audio/mp4",
        "audio/webm;codecs=opus",
        "audio/webm"
      ];
      if (!window.MediaRecorder || !MediaRecorder.isTypeSupported) return "";
      for (const c of candidates){
        if (MediaRecorder.isTypeSupported(c)) return c;
      }
      return "";
    }

    function extFromType(t){
      if (!t) return "webm";
      if (t.includes("mp4")) return "m4a";
      if (t.includes("webm")) return "webm";
      return "webm";
    }

    async function startRecording(){
      if (!navigator.mediaDevices?.getUserMedia){
        throw new Error("getUserMedia not supported");
      }
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      chunks = [];
      recordedBlob = null;
      recordedFile = null;

      const mimeType = pickMimeType();
      recorder = new MediaRecorder(mediaStream, mimeType ? { mimeType } : undefined);

      recorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) chunks.push(e.data);
      };

      recorder.onstop = () => {
        const type = recorder.mimeType || mimeType || "audio/webm";
        recordedBlob = new Blob(chunks, { type });
        const ext = extFromType(type);
        const filename = `rooftop_reflection.${ext}`;
        recordedFile = new File([recordedBlob], filename, { type });

        setBtn(sendBtn, "üì§ Send to Sandra", true);

        if (mediaStream){
          mediaStream.getTracks().forEach(t => t.stop());
          mediaStream = null;
        }
      };

      recorder.start();
      isRecording = true;
      setBtn(recordBtn, "‚èπ Stop", true);
      setBtn(sendBtn, "üì§ Send to Sandra", false);
      hintEl.textContent = "Recording‚Ä¶ Answer A then B in one take. Tap Stop when done.";
    }

    function stopRecording(){
      if (recorder && isRecording) recorder.stop();
      isRecording = false;
      setBtn(recordBtn, "üéôÔ∏è Record again", true);
      hintEl.textContent = "Nice. Now tap ‚ÄúSend to Sandra‚Äù.";
    }

    recordBtn.addEventListener("click", async () => {
      try{
        if (!isRecording) await startRecording();
        else stopRecording();
      } catch (err){
        console.error(err);
        hintEl.textContent = "Mic permission blocked (or not supported). Please allow microphone access and try again.";
      }
    });

    // -----------------------------
    // Share + Confirmation Modal
    // -----------------------------
    function forceDownload(){
      if (!recordedBlob || !recordedFile) return;
      const url = URL.createObjectURL(recordedBlob);
      const a = document.createElement("a");
      a.href = url;
      a.download = recordedFile.name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    }

    function showShareModal(){
      shareModalBack.classList.add("show");
      modalDownload.classList.toggle("disabled", !recordedFile);
      modalRetry.classList.toggle("disabled", !recordedFile);
    }
    function hideShareModal(){
      shareModalBack.classList.remove("show");
    }

    async function doShare(){
      if (!recordedFile) return;

      // If no share sheet, just show modal and allow download.
      if (!navigator.share){
        showShareModal();
        return;
      }

      try{
        await navigator.share({
          files: [recordedFile],
          text: SHARE_TEXT,
          title: "Rooftop Reflection"
        });
      } catch (err){
        // cancelled or failed ‚Äì we still go to confirmation modal
        console.log("Share cancelled/failed:", err);
      } finally {
        // Always show the confirmation modal after share sheet closes
        showShareModal();
      }
    }

    sendBtn.addEventListener("click", async () => {
      try{
        hintEl.textContent = "Choose Telegram and send it to Sandra.";
        await doShare();
      } catch (err){
        console.error(err);
        showShareModal();
      }
    });

    modalDownload.addEventListener("click", () => {
      forceDownload();
    });

    modalRetry.addEventListener("click", async () => {
      // attempt share again
      hideShareModal();
      await doShare();
    });

    // YES -> start surprise immediately
    modalYes.addEventListener("click", () => {
      hideShareModal();
      miniPopup.classList.add("show");
    });

    // NO -> reveal download + retry
    modalNo.addEventListener("click", () => {
      modalDownload.classList.remove("disabled");
      modalRetry.classList.remove("disabled");
    });

    // -----------------------------
    // Mini Surprise
    // -----------------------------
    let surpriseStarted = false;

    function startSurprise(){
      miniPopup.classList.remove("show");

      // Hide record/share controls + hint
      card.classList.add("hideControls");

      // Switch typed text to the letter (typing effect)
      typewrite(surpriseLetter);

      // Start animation state
      resetSurpriseState();
      surpriseStarted = true;
    }

    miniGo.addEventListener("click", startSurprise);
    miniPopup.addEventListener("click", startSurprise);

    // -----------------------------
    // STATIC skyline (prebuilt once)
    // -----------------------------
    function mulberry32(seed){
      let a = seed >>> 0;
      return function(){
        a |= 0; a = (a + 0x6D2B79F5) | 0;
        let t = Math.imul(a ^ (a >>> 15), 1 | a);
        t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function buildSkyLayer(seed, yMin, yMax, wMin, wMax){
      const rnd = mulberry32(seed);
      const rects = [];
      let x = 0;

      while (x < canvas.width + 30){
        const w = wMin + rnd() * (wMax - wMin);
        const h = (yMax - yMin) * (0.4 + rnd() * 0.9);
        const y = yMax - h;

        const windows = [];
        const winCount = 10; // more windows overall
        for (let i=0;i<winCount;i++){
          windows.push({
            wx: x + 2 + rnd()*(Math.max(4, w-6)),
            wy: y + 4 + rnd()*(Math.max(8, h-10)),
            s: 1 + Math.floor(rnd()*2) // 1-2 px
          });
        }

        rects.push({ x, y, w, h, windows });
        x += w + 6;
      }
      return rects;
    }

    const skylineLayers = [
      { color:"#1b3f73", alpha:0.45, winAlpha:0.55, rects: buildSkyLayer(101, 40, 210, 10, 18) },
      { color:"#25518f", alpha:0.55, winAlpha:0.50, rects: buildSkyLayer(202, 80, 260, 14, 22) },
      { color:"#2f68b8", alpha:0.70, winAlpha:0.45, rects: buildSkyLayer(303, 130, 320, 18, 28) }
    ];

    // Stars
    const stars = makeStars(95);
    function makeStars(n){
      const arr = [];
      for (let i=0;i<n;i++){
        arr.push({
          x: Math.random()*canvas.width,
          y: Math.random()*170,
          r: 0.6 + Math.random()*1.4,
          tw: Math.random()*Math.PI*2
        });
      }
      return arr;
    }

    // Fireworks particles
    let fireworksOn = false;
    let particles = [];
    let lastFireworkAt = 0;

    function spawnFirework(){
      const cx = 120 + Math.random()*(canvas.width-240);
      const cy = 60 + Math.random()*150;
      const count = 40;

      for (let i=0;i<count;i++){
        const a = (i/count) * Math.PI*2;
        const sp = 1.2 + Math.random()*2.0;
        particles.push({
          x: cx, y: cy,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp,
          life: 120 + Math.random()*45
        });
      }
    }

    function updateFireworks(){
      const now = performance.now();
      if (fireworksOn && now - lastFireworkAt > 650){
        lastFireworkAt = now;
        spawnFirework();
      }
      for (const p of particles){
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.01;
        p.life -= 1;
      }
      particles = particles.filter(p => p.life > 0);
    }

    function drawFireworks(){
      if (particles.length === 0) return;
      ctx.save();
      for (const p of particles){
        const a = Math.max(0, Math.min(1, p.life/170));
        ctx.fillStyle = `rgba(255,255,255,${0.25 + 0.65*a})`;
        ctx.fillRect(p.x, p.y, 2, 2);
      }
      ctx.restore();
    }

    // Surprise actor (you)
    const you = {
      x: -80,
      y: 420,
      targetX: 250,
      walking: false,
      arrived: false,
      bouquetGiven: false
    };

    // Bouquet animation
    const bouquet = {
      active:false,
      t:0,
      fromX:0, fromY:0,
      toX:0, toY:0,
      x:0, y:0,
      done:false
    };

    function lerp(a,b,t){ return a + (b-a)*t; }
    function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }

    function resetSurpriseState(){
      you.x = -80;
      you.walking = true;
      you.arrived = false;
      you.bouquetGiven = false;

      bouquet.active = false;
      bouquet.t = 0;
      bouquet.done = false;

      fireworksOn = false;
      particles = [];
    }

    function drawScene(t){
      // Sky
      const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
      g.addColorStop(0, "#04101f");
      g.addColorStop(1, "#0f2742");
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Stars (tiny twinkle is fine)
      ctx.save();
      for (const s of stars){
        const tw = 0.35 + 0.65*(0.5 + 0.5*Math.sin(t/900 + s.tw));
        ctx.fillStyle = `rgba(255,255,255,${0.12 + 0.45*tw})`;
        ctx.fillRect(s.x, s.y, s.r, s.r);
      }
      ctx.restore();

      drawCrescentMoon(610, 80, 22);
      drawSkylineStatic();
      drawRooftopDeck();

      // Fireworks behind foreground
      drawFireworks();

      // agy96
      drawAgySitting(160, 444);

      // you only animates after surprise started
      if (surpriseStarted) drawYouAndBouquet();

      // vignette
      ctx.fillStyle = "rgba(0,0,0,0.20)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawCrescentMoon(x,y,r){
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.75)";
      ctx.beginPath();
      ctx.arc(x,y,r,0,Math.PI*2);
      ctx.fill();

      ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath();
      ctx.arc(x+8,y-2,r,0,Math.PI*2);
      ctx.fill();
      ctx.globalCompositeOperation = "source-over";

      const rg = ctx.createRadialGradient(x,y,2,x,y,80);
      rg.addColorStop(0,"rgba(255,255,255,0.10)");
      rg.addColorStop(1,"rgba(255,255,255,0.0)");
      ctx.fillStyle = rg;
      ctx.beginPath();
      ctx.arc(x,y,80,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    function drawSkylineStatic(){
      for (let li = 0; li < skylineLayers.length; li++){
        const L = skylineLayers[li];

        ctx.save();
        ctx.globalAlpha = L.alpha;
        ctx.fillStyle = L.color;

        for (const r of L.rects){
          ctx.fillRect(r.x, r.y, r.w, r.h);

          // Windows: ALL rows get warm glow.
          // Nearer rows get slightly stronger visibility.
          const rowBoost = (li === 2) ? 1.0 : (li === 1 ? 0.85 : 0.70);

          ctx.save();
          ctx.shadowColor = "rgba(255,220,120,0.55)";
          ctx.shadowBlur = 6;
          ctx.fillStyle = `rgba(255,220,120,${L.winAlpha * rowBoost})`;

          for (const w of r.windows){
            ctx.fillRect(w.wx, w.wy, w.s, w.s);
          }
          ctx.restore();

          // restore building color
          ctx.fillStyle = L.color;
        }

        ctx.restore();
      }

      // Water band
      ctx.fillStyle = "#062242";
      ctx.fillRect(0, 330, canvas.width, 70);

      // Water sparkles
      ctx.fillStyle = "rgba(255,255,255,0.22)";
      for (let i=0;i<40;i++){
        const x = (i/40) * canvas.width + (Math.sin(i*9)*4);
        const y = 350 + (i%6)*6;
        ctx.fillRect(x, y, 3, 1);
      }
    }

    function drawRooftopDeck(){
      ctx.fillStyle = "#101010";
      ctx.fillRect(0, 400, canvas.width, 160);

      // Glass railing
      ctx.fillStyle = "rgba(255,255,255,0.10)";
      ctx.fillRect(80, 370, 560, 38);
      ctx.strokeStyle = "rgba(255,255,255,0.20)";
      ctx.lineWidth = 2;
      ctx.strokeRect(80, 370, 560, 38);

      // Posts
      ctx.fillStyle = "rgba(255,255,255,0.18)";
      for (let x=90;x<=630;x+=70){
        ctx.fillRect(x, 370, 4, 38);
      }

      // Couch
      ctx.fillStyle = "#6a5a1a";
      ctx.fillRect(110, 430, 210, 70);
      ctx.fillStyle = "#7a6820";
      ctx.fillRect(110, 420, 210, 16);

      // Table
      ctx.fillStyle = "#c8b79a";
      ctx.fillRect(350, 452, 90, 38);
      ctx.fillStyle = "#b8a788";
      ctx.fillRect(360, 444, 70, 10);

      // Plant pot
      ctx.fillStyle = "#d1b06a";
      ctx.fillRect(510, 450, 44, 50);
      ctx.fillStyle = "#c09a58";
      ctx.fillRect(516, 440, 32, 10);
      // Plant
      ctx.fillStyle = "#30c15b";
      ctx.fillRect(520, 418, 24, 24);
      ctx.fillStyle = "#27a94c";
      ctx.fillRect(526, 410, 12, 12);
    }

    function drawAgySitting(x, y){
      ctx.save();
      ctx.translate(x, y);

      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.font = "bold 12px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("agy96", 0, -70);

      // Hair
      ctx.fillStyle = "#0a0a0a";
      ctx.fillRect(-20, -62, 40, 34);
      ctx.fillRect(-22, -58, 4, 30);
      ctx.fillRect(18,  -58, 4, 30);
      ctx.fillRect(-20, -28, 40, 7);

      // Face
      ctx.fillStyle = "#f1c9a8";
      ctx.fillRect(-14, -50, 28, 22);

      // Glasses
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.strokeRect(-12, -46, 10, 8);
      ctx.strokeRect(2, -46, 10, 8);
      ctx.beginPath(); ctx.moveTo(-2, -42); ctx.lineTo(2, -42); ctx.stroke();

      // Torso
      ctx.fillStyle = "#c43737";
      ctx.fillRect(-16, -28, 32, 20);

      // Seated legs (even)
      ctx.fillStyle = "#1f2530";
      ctx.fillRect(-16, -8, 16, 12);
      ctx.fillRect(0,   -8, 16, 12);

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(-16, 4, 16, 6);
      ctx.fillRect(0,   4, 16, 6);

      // Arms
      ctx.fillStyle = "#f1c9a8";
      ctx.fillRect(-20, -26, 4, 16);
      ctx.fillRect(16, -26, 4, 16);

      ctx.restore();
    }

    function drawBouquetAt(bx, by){
      const rg = ctx.createRadialGradient(bx, by, 4, bx, by, 70);
      rg.addColorStop(0, "rgba(255,230,200,0.18)");
      rg.addColorStop(1, "rgba(255,230,200,0.00)");
      ctx.fillStyle = rg;
      ctx.beginPath();
      ctx.arc(bx, by, 70, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "#ff7ab6";
      ctx.fillRect(bx-8, by-12, 6, 6);
      ctx.fillRect(bx,   by-14, 6, 6);
      ctx.fillRect(bx+8, by-10, 6, 6);
      ctx.fillStyle = "#ffd1e5";
      ctx.fillRect(bx-2, by-6, 6, 6);

      ctx.fillStyle = "#30c15b";
      ctx.fillRect(bx-6, by, 6, 6);
      ctx.fillRect(bx+6, by, 6, 6);

      ctx.fillStyle = "#f2e6d6";
      ctx.fillRect(bx-6, by+6, 16, 10);

      ctx.fillStyle = "rgba(255,255,255,0.75)";
      if ((Math.floor(performance.now()/120) % 2) === 0){
        ctx.fillRect(bx+18, by-16, 2, 2);
      }
    }

    function drawYouAndBouquet(){
      // Move in
      if (you.walking){
        you.x += 3.2;
        if (you.x >= you.targetX){
          you.x = you.targetX;
          you.walking = false;
          you.arrived = true;

          setTimeout(() => {
            you.bouquetGiven = true;

            bouquet.active = true;
            bouquet.done = false;
            bouquet.t = 0;

            // From your LEFT hand (near agy)
            bouquet.fromX = you.x - 44;
            bouquet.fromY = you.y - 18;

            // To next to agy (beside her on couch)
            bouquet.toX = 220;
            bouquet.toY = 410;

            // Audio + fireworks begin after bouquet starts
            bdayAudio.currentTime = 0;
            bdayAudio.play().catch(()=>{});

            fireworksOn = true;
            lastFireworkAt = performance.now();
          }, 500);
        }
      }

      // Draw you
      ctx.save();
      ctx.translate(you.x, you.y);

      // label
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.font = "bold 12px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("sljy14", 0, -70);

      // shadow
      ctx.fillStyle = "rgba(0,0,0,0.25)";
      ctx.beginPath();
      ctx.ellipse(0, 26, 26, 8, 0, 0, Math.PI*2);
      ctx.fill();

      // Hair
      ctx.fillStyle = "#111";
      ctx.fillRect(-18, -52, 36, 30);

      // Face
      ctx.fillStyle = "#eab48f";
      ctx.fillRect(-12, -40, 24, 18);

      // Black tee
      ctx.fillStyle = "#0b0b0b";
      ctx.fillRect(-14, -22, 28, 18);

      // Black mini skirt
      ctx.fillStyle = "#101010";
      ctx.fillRect(-14, -4, 28, 12);

      // Legs
      ctx.fillStyle = "#eab48f";
      ctx.fillRect(-12, 8, 10, 12);
      ctx.fillRect(2, 8, 10, 12);

      // Shoes
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(-12, 20, 10, 6);
      ctx.fillRect(2, 20, 10, 6);

      // Arms
      ctx.fillStyle = "#eab48f";

      // LEFT arm (near agy) extends + holds bouquet
      if (you.bouquetGiven){
        ctx.fillRect(-26, -16, 12, 4); // extended toward agy
      } else {
        ctx.fillRect(-18, -18, 4, 16); // down
      }

      // RIGHT arm down straight
      ctx.fillRect(14, -18, 4, 16);

      ctx.restore();

      // Bouquet movement (outside the translate, so it lands correctly)
      if (bouquet.active && !bouquet.done){
        bouquet.t += 1/40;
        const tt = Math.min(1, bouquet.t);
        const e = easeOutCubic(tt);

        bouquet.x = lerp(bouquet.fromX, bouquet.toX, e);
        bouquet.y = lerp(bouquet.fromY, bouquet.toY, e);

        drawBouquetAt(bouquet.x, bouquet.y);

        if (tt >= 1) bouquet.done = true;
      } else if (bouquet.done){
        drawBouquetAt(bouquet.toX, bouquet.toY);
      }
    }

    // Loop
    let last = performance.now();
    function loop(now){
      last = now;

      updateFireworks();
      drawScene(now);

      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  </script>
</body>
</html>
