<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Stadium Run</title>
  <style>
    :root{
      --bg1:#0b1c2d;
      --bg2:#162a3d;
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --stroke: rgba(255,255,255,0.12);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% -10%, rgba(255,255,255,0.08), transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      color: var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding: 18px 14px 28px;
    }
    .wrap{ width:min(760px, 100%); }

    h1{
      margin: 6px 0 6px;
      text-align:center;
      font-size: 38px;
      letter-spacing:-0.5px;
      line-height:1.05;
      font-weight: 800;
      text-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .sub{
      text-align:center;
      color: var(--muted);
      font-size: 15px;
      margin-bottom: 14px;
    }
    .sub2{
      text-align:center;
      color: var(--muted2);
      font-size: 14px;
      margin-top: -6px;
      margin-bottom: 14px;
    }
    .hud{
      display:flex;
      gap:12px;
      justify-content:center;
      margin: 8px 0 14px;
      flex-wrap: wrap;
    }
    .pill{
      min-width: 220px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.05));
      box-shadow: 0 10px 30px rgba(0,0,0,0.25) inset, 0 8px 24px rgba(0,0,0,0.15);
      display:flex;
      justify-content:center;
      gap:10px;
      align-items:center;
      font-weight: 700;
      color: rgba(255,255,255,0.9);
    }
    .gameCard{
      width:100%;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.16);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      padding: 16px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.35);
      position:relative;
      overflow:hidden;
    }
    canvas{
      width:100%;
      height:auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.08);
      display:block;
      touch-action: manipulation;
    }

    /* Win overlay */
    .overlay{
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65));
      display:none;
      align-items:center;
      justify-content:flex-start;
      flex-direction:column;
      padding: 20px 16px;
      gap: 14px;
    }
    .overlay.show{ display:flex; }
    .overlay h2{
      margin: 10px 0 0;
      font-size: 22px;
      text-align:center;
      font-weight: 800;
      color: rgba(255,255,255,0.95);
      text-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    .cta{
      width: min(520px, 92%);
      padding: 16px 18px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.95);
      font-weight: 800;
      font-size: 18px;
      text-align:center;
      box-shadow: 0 18px 48px rgba(0,0,0,0.35);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .cta:active{ transform: translateY(1px); }

    @media (max-width: 420px){
      h1{ font-size: 34px; }
      .pill{ min-width: 160px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Welcome to the Stadium<br/>Run! üèüÔ∏è</h1>
    <div class="sub">Click to jump over barricades. Reach 10 to win.</div>
    <div class="sub2">Click anywhere inside the game.</div>

    <div class="hud">
      <div class="pill">üèÅ <span>Clears:</span> <span id="clearsTxt">0 / 10</span></div>
      <div class="pill">üí• <span>Hits:</span> <span id="hitsTxt">0</span></div>
    </div>

    <div class="gameCard">
      <canvas id="game" width="720" height="560"></canvas>

      <div id="winOverlay" class="overlay">
        <h2>Now that we‚Äôre reaching nightfall, time for some quiet time. üåÉ</h2>
        <div class="cta" id="toRooftopBtn">Ready for my me time</div>
      </div>
    </div>
  </div>
  
<audio id="bgm" src="./arcade.mp3" preload="auto" loop></audio>
  
  <script>
    // =========================
    // Stadium Run (clean rebuild)
    // =========================

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const clearsTxt = document.getElementById("clearsTxt");
    const hitsTxt   = document.getElementById("hitsTxt");
    const winOverlay = document.getElementById("winOverlay");
    const toRooftopBtn = document.getElementById("toRooftopBtn");

    const GOAL_CLEARS = 10;

    const world = {
      gravity: 0.85,
      groundY: 470,
      speed: 4.2,
      jumpVelocity: -14.2,
      spawnMin: 900,
      spawnMax: 1400
    };

    const player = {
      x: 170,
      y: world.groundY,
      vy: 0,
      w: 44,
      h: 74,
      isJumping: false
    };

    let barriers = [];
    let lastSpawnAt = performance.now();
    let nextSpawnIn = rand(world.spawnMin, world.spawnMax);

    let clears = 0;
    let hits = 0;

    let running = true;
    let won = false;

    const winAnim = {
      active: false,
      t: 0,
      hopsDone: 0,
      clapBursts: [],
      hopSide: 0
    };

    const finishLine = {
      x: 540,
      y: world.groundY + 6,
      w: 8,
      h: 120
    };

    // ---------- Crowd (prebuilt, slow animate) ----------
    const crowd = buildCrowd(54);

    function buildCrowd(n){
      const people = [];
      for (let i=0;i<n;i++){
        people.push({
          x: (i/(n-1)) * (canvas.width - 40) + 20,
          shirt: ["#2f6fff","#c43737","#ffd400","#ffffff","#111111","#7a4cff"][i % 6],
          skin:  ["#f1c9a8","#eab48f","#d79a73"][i % 3],
          hair:  ["#111111","#222222","#0a0a0a"][i % 3],
          phase: (i * 0.45) % (Math.PI * 2),
          cheer: (i % 5 === 0)
        });
      }
      return people;
    }

    // -------------------------
    // Input
    // -------------------------
    function jump(){
      if (!running || won) return;
      if (player.y >= world.groundY - 0.5){
        player.vy = world.jumpVelocity;
        player.isJumping = true;
      }
    }
    canvas.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      jump();
    }, {passive:false});
    canvas.addEventListener("touchstart", (e) => e.preventDefault(), {passive:false});

    // -------------------------
    // Utilities
    // -------------------------
    function rand(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function clamp(v, a, b){
      return Math.max(a, Math.min(b, v));
    }
    function intersects(a, b){
      return !(a.x + a.w < b.x || a.x > b.x + b.w || a.y + a.h < b.y || a.y > b.y + b.h);
    }
    function nowSince(t){
      return performance.now() - t;
    }

    // -------------------------
    // HUD
    // -------------------------
    function updateHUD(){
      clearsTxt.textContent = `${clears} / ${GOAL_CLEARS}`;
      hitsTxt.textContent = `${hits}`;
    }
    updateHUD();

    // -------------------------
    // Restart logic (on hit)
    // -------------------------
    function restartGame(){
      clears = 0;
      hits = 0;
      updateHUD();

      player.x = 170;
      player.y = world.groundY;
      player.vy = 0;
      player.isJumping = false;

      barriers = [];
      lastSpawnAt = performance.now();
      nextSpawnIn = rand(world.spawnMin, world.spawnMax);

      running = true;
      won = false;
      winOverlay.classList.remove("show");
    }

    // -------------------------
    // Backgrounds
    // -------------------------
    function drawStadiumBackground(){
      drawBaseStadium();
      // Big diagonal stripe (gameplay only)
      ctx.fillStyle = "rgba(255,255,255,0.58)";
      ctx.save();
      ctx.translate(230, 210);
      ctx.rotate(-0.28);
      ctx.fillRect(0, 0, 18, 350);
      ctx.restore();
    }

    function drawWinBackground(){
      // Same stadium, but WITHOUT diagonal stripe / random pole
      drawBaseStadium();
    }

    function drawBaseStadium(){
      // Sky gradient
      const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
      g.addColorStop(0, "#0b1c2d");
      g.addColorStop(1, "#162a3d");
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Soft vignette
      ctx.fillStyle = "rgba(0,0,0,0.18)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Crowd band
      ctx.fillStyle = "#caa76c";
      ctx.fillRect(0, 60, canvas.width, 34);

      // Stand shadow band
      ctx.fillStyle = "#2b3f63";
      ctx.fillRect(0, 94, canvas.width, 30);

      drawCrowd(performance.now());

      // Field green bands
      ctx.fillStyle = "#2fdc2a";
      ctx.fillRect(0, 124, canvas.width, 54);
      ctx.fillStyle = "#26c624";
      ctx.fillRect(0, 178, canvas.width, 26);

      // Track
      ctx.fillStyle = "#5b2e2e";
      ctx.fillRect(0, 204, canvas.width, canvas.height - 204);

      // Lane dashed lines
      ctx.strokeStyle = "rgba(255,255,255,0.42)";
      ctx.lineWidth = 2;
      ctx.setLineDash([12, 12]);
      for(let y=250; y<=520; y+=40){
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
      ctx.setLineDash([]);

      // Stadium lights poles + glow
      drawLightPole(90, 45);
      drawLightPole(canvas.width/2, 40);
      drawLightPole(canvas.width-90, 45);

      // Gentle atmospheric haze
      const haze = ctx.createLinearGradient(0, 0, 0, canvas.height);
      haze.addColorStop(0, "rgba(255,255,255,0.05)");
      haze.addColorStop(1, "rgba(255,255,255,0.00)");
      ctx.fillStyle = haze;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawLightPole(x, yTop){
      // Pole
      ctx.fillStyle = "rgba(200,220,255,0.28)";
      ctx.fillRect(x-4, yTop+10, 8, 70);

      // Light head
      ctx.fillStyle = "rgba(255,255,255,0.80)";
      ctx.fillRect(x-14, yTop, 28, 12);

      // Lamps
      ctx.fillStyle = "#ffd86b";
      ctx.fillRect(x-12, yTop+2, 8, 8);
      ctx.fillRect(x-0,  yTop+2, 8, 8);

      // Glow
      const rg = ctx.createRadialGradient(x, yTop+6, 2, x, yTop+6, 90);
      rg.addColorStop(0, "rgba(255,226,140,0.32)");
      rg.addColorStop(1, "rgba(255,226,140,0.0)");
      ctx.fillStyle = rg;
      ctx.beginPath();
      ctx.arc(x, yTop+6, 90, 0, Math.PI*2);
      ctx.fill();
    }

    function drawCrowd(t){
      const beat = Math.sin(t/3000);

      for (const p of crowd){
        const baseY = 72;
        const wobble = Math.sin(t/1800 + p.phase) * 1.2;
        const y = baseY + wobble;

        // head
        ctx.fillStyle = p.skin;
        ctx.fillRect(p.x - 3, y - 6, 6, 6);

        // hair cap
        ctx.fillStyle = p.hair;
        ctx.fillRect(p.x - 3, y - 6, 6, 2);

        // body (shirt)
        ctx.fillStyle = p.shirt;
        ctx.fillRect(p.x - 4, y, 8, 7);

        // legs
        ctx.fillStyle = "#111";
        ctx.fillRect(p.x - 3, y + 7, 2, 3);
        ctx.fillRect(p.x + 1, y + 7, 2, 3);

        // arms (slow cheer)
        const cheeringNow = p.cheer && beat > 0.55;
        ctx.fillStyle = p.skin;
        if (cheeringNow){
          ctx.fillRect(p.x - 6, y - 1, 2, 6);
          ctx.fillRect(p.x + 4, y - 1, 2, 6);
        } else {
          ctx.fillRect(p.x - 6, y + 1, 2, 6);
          ctx.fillRect(p.x + 4, y + 1, 2, 6);
        }
      }
    }

    // -------------------------
    // Obstacles
    // -------------------------
    function spawnBarrier(){
      barriers.push({
        x: canvas.width + 30,
        y: world.groundY + 4,
        w: 42,
        h: 26,
        passed: false
      });
    }

    function drawBarrier(b){
      ctx.save();
      ctx.translate(b.x, b.y);

      // base shadow
      ctx.fillStyle = "rgba(0,0,0,0.25)";
      ctx.fillRect(2, 14, b.w-4, 10);

      // legs
      ctx.fillStyle = "#6d6f77";
      ctx.fillRect(4, 6, 6, 18);
      ctx.fillRect(b.w-10, 6, 6, 18);

      // top rail
      ctx.fillStyle = "#9aa0ab";
      ctx.fillRect(0, 0, b.w, 8);

      // stripes
      for(let i=0;i<4;i++){
        ctx.fillStyle = (i%2===0) ? "#d24a4a" : "#f2f2f2";
        ctx.fillRect(6 + i*9, 2, 7, 4);
      }

      ctx.restore();
    }

    // -------------------------
    // Avatar (agy96)
    // -------------------------
    function drawPlayer(){
      ctx.save();
      ctx.translate(player.x, player.y);

      // floor shadow
      ctx.fillStyle = "rgba(0,0,0,0.28)";
      ctx.beginPath();
      ctx.ellipse(0, 26, 30, 10, 0, 0, Math.PI*2);
      ctx.fill();

      // Name label (always above head)
      drawNameLabel(ctx);

      drawHair(ctx);
      drawFace(ctx);
      drawGlasses(ctx);
      drawBody(ctx);
      drawLegs(ctx);
      drawArms(ctx);

      ctx.restore();
    }

    function drawNameLabel(c){
      c.fillStyle = "#ffffff";
      c.font = "bold 12px sans-serif";
      c.textAlign = "center";
      c.fillText("agy96", 0, -58);
    }

    function drawHair(c){
      c.fillStyle = "#0a0a0a";
      // main block
      c.fillRect(-20, -52, 40, 34);
      // thicker sides
      c.fillRect(-22, -48, 4, 30);
      c.fillRect(18,  -48, 4, 30);
      // bottom extension
      c.fillRect(-20, -18, 40, 7);
    }

    function drawFace(c){
      c.fillStyle = "#f1c9a8";
      c.fillRect(-14, -40, 28, 22);
    }

    function drawGlasses(c){
      c.strokeStyle = "#000";
      c.lineWidth = 2;
      c.strokeRect(-12, -36, 10, 8);
      c.strokeRect(2, -36, 10, 8);
      c.beginPath();
      c.moveTo(-2, -32);
      c.lineTo(2, -32);
      c.stroke();
    }

    function drawBody(c){
      c.fillStyle = "#c43737";
      c.fillRect(-16, -18, 32, 24);
      c.fillStyle = "#1f2530";
      c.fillRect(-16, 6, 32, 18);
    }

    function drawLegs(c){
      c.fillStyle = "#ffffff";
      c.fillRect(-16, 24, 32, 8);
    }

    function drawArms(c){
      c.fillStyle = "#f1c9a8";
      c.fillRect(-20, -14, 4, 18);
      c.fillRect(16, -14, 4, 18);
    }

    // -------------------------
    // Win animation
    // -------------------------
    function triggerWin(){
      won = true;
      running = false;

      winAnim.active = true;
      winAnim.t = 0;
      winAnim.hopsDone = 0;
      winAnim.clapBursts = [];
      winAnim.hopSide = 0;

      barriers = [];

      player.x = 300;
      player.y = world.groundY;
      player.vy = 0;
      player.isJumping = false;

      // Overlay appears after 5s
      winOverlay.classList.remove("show");
      setTimeout(() => winOverlay.classList.add("show"), 5000);
    }

    function drawWinScene(dt){
      drawWinBackground();

      // Slight darken
      ctx.fillStyle = "rgba(0,0,0,0.08)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);


      // hop 5x
      if (winAnim.active){
        winAnim.t += dt;
        if (winAnim.t > 380){
          winAnim.t = 0;
          winAnim.hopsDone++;

          winAnim.hopSide = 1 - winAnim.hopSide;
          player.x = (winAnim.hopSide === 0) ? 300 : 420;

          player.vy = -11.8;
          player.isJumping = true;

          spawnClaps();

          if (winAnim.hopsDone >= 5){
            winAnim.active = false;
            player.vy = 0;
            player.y = world.groundY;
            player.isJumping = false;
          }
        }
      }

      applyPhysics();
      drawClaps(dt);
      drawPlayer();
    }

    function drawFinishLine(){
      ctx.fillStyle = "rgba(255,255,255,0.70)";
      ctx.fillRect(finishLine.x, 220, finishLine.w, finishLine.h);
    }

    function spawnClaps(){
      for (let i=0;i<8;i++){
        winAnim.clapBursts.push({
          x: player.x + rand(-80, 80),
          y: player.y - 180 + rand(-20, 60),
          life: 1800
        });
      }
    }

    function drawClaps(dt){
      for (const p of winAnim.clapBursts){
        p.life -= dt;
        p.y -= 0.02 * dt;
      }
      winAnim.clapBursts = winAnim.clapBursts.filter(p => p.life > 0);

      ctx.save();
      ctx.font = "22px sans-serif";
      ctx.textAlign = "center";
      for (const p of winAnim.clapBursts){
        const a = clamp(p.life / 1800, 0, 1);
        ctx.fillStyle = `rgba(255,255,255,${0.35 + 0.65*a})`;
        ctx.fillText("üëè", p.x, p.y);
      }
      ctx.restore();
    }

    // -------------------------
    // Game loop
    // -------------------------
    let last = performance.now();

    function loop(now){
      const dt = now - last;
      last = now;

      if (!won){
        update(dt);
        render();
      } else {
        drawWinScene(dt);
      }

      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    function update(dt){
      if (!running) return;

      applyPhysics();

      if (nowSince(lastSpawnAt) > nextSpawnIn){
        spawnBarrier();
        lastSpawnAt = performance.now();
        nextSpawnIn = rand(world.spawnMin, world.spawnMax);
      }

      for (const b of barriers) b.x -= world.speed;

      // Remove offscreen + count clears
      barriers = barriers.filter(b => {
        if (!b.passed && b.x + b.w < player.x - 10){
          b.passed = true;
          clears++;
          updateHUD();
          if (clears >= GOAL_CLEARS) triggerWin();
        }
        return b.x + b.w > -60;
      });

      // Collision => restart run
      const playerBox = {
        x: player.x - (player.w/2) + 6,
        y: player.y - player.h + 8,
        w: player.w - 12,
        h: player.h - 8
      };

      for (const b of barriers){
        const barrierBox = {
          x: b.x + 4,
          y: b.y - b.h + 8,
          w: b.w - 8,
          h: b.h - 8
        };
        if (intersects(playerBox, barrierBox)){
          hits++;
          updateHUD();
          restartGame(); // resets clears/hits + barriers
          break;
        }
      }
    }

    function applyPhysics(){
      player.vy += world.gravity;
      player.y += player.vy;

      if (player.y >= world.groundY){
        player.y = world.groundY;
        player.vy = 0;
        player.isJumping = false;
      }
    }

    function render(){
      drawStadiumBackground();
      for (const b of barriers) drawBarrier(b);
      drawPlayer();
    }

    // -------------------------
    // Button: go to rooftop scene
    // -------------------------
   toRooftopBtn.addEventListener("click", () => {
  // Mark Stadium done (so state machine never backtracks)
  localStorage.setItem("done_stadium", "1");

  // Optional: also lock the prompt index to the final step
  // (helps if rooftop ever routes back to map)
  localStorage.setItem("mapPromptIndex", "4");

  const nextUrl = "rooftop.html?t=" + Date.now();
  if (window.playThenNavigate) {
    window.playThenNavigate(nextUrl);
    return;
  }
  // Cache-bust to avoid iOS Safari restoring an old page state
  window.location.href = nextUrl;
});

  </script>
<script src="./js/bgm.js"></script>

  
</body>
</html>
