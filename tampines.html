<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>First Stop: Tampines</title>

<style>
  html,body{
    margin:0;height:100%;
    background:
      radial-gradient(900px 520px at 50% 25%, rgba(120,255,235,0.14), transparent 62%),
      radial-gradient(900px 520px at 50% 75%, rgba(160,120,255,0.12), transparent 62%),
      linear-gradient(160deg,#06202a,#070714);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:#fff;
  }

  .wrap{
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    padding:18px 16px 14px;
    box-sizing:border-box;
  }

  h1{
    margin:6px 0 6px;
    font-weight:1000;
    letter-spacing:-0.5px;
    font-size:28px;
    text-align:center;
  }
  .sub{
    margin:0 0 12px;
    opacity:0.86;
    text-align:center;
    font-size:14px;
  }

  .gameCard{
    width:min(380px, 94vw);
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    border-radius:18px;
    padding:14px;
    box-sizing:border-box;
  }

  .hudRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
    gap:10px;
  }
  .hint{
    font-size:12px;
    opacity:0.9;
    line-height:1.2;
  }
  .badge{
    font-weight:900;
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.15);
    background:rgba(255,255,255,0.08);
    white-space:nowrap;
  }

  /* ===== Maze stage ===== */
  .stage{
    position:relative;
    width:100%;
    aspect-ratio: 3 / 4;
    border-radius:14px;
    overflow:hidden;
    background:linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.28));
    border:1px solid rgba(255,255,255,0.10);
  }

  canvas{
    width:100%;
    height:100%;
    display:block;
    image-rendering:pixelated;
  }

  /* Floating name tag above avatar */
  .miniAgyTag{
    position:absolute;
    transform: translate(-50%, -50%);
    font-weight:900;
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.15);
    background:rgba(0,0,0,0.28);
    pointer-events:none;
  }

  /* Mini avatar wrapper */
  .miniAgy{
    position:absolute;
    transform: translate(-50%, -50%) scale(0.45);
    transform-origin: top left;
    pointer-events:none;
  }

  /* ===== agy96 avatar (same as your main page style) ===== */
  .pixel{ width:140px; height:220px; position:relative; margin:0; filter:none; }

  .hair{
    position:absolute; width:92px; height:130px; background:#000;
    top:0; left:50%; transform:translateX(-50%); border-radius:10px;
  }
  .face{
    position:absolute; width:60px; height:72px; background:#f1c7a6;
    top:34px; left:50%; transform:translateX(-50%); border-radius:2px;
  }
  .glasses{
    position:absolute; top:60px; left:50%; transform:translateX(-50%);
    display:flex; align-items:center; gap:0;
  }
  .glasses .side{ width:12px; height:4px; background:#000; }
  .glasses .lens{ width:24px; height:18px; border:4px solid #000; box-sizing:border-box; }
  .glasses .bridge{ width:10px; height:4px; background:#000; }

  /* red tee */
  .body{
    position:absolute; top:118px; left:50%; transform:translateX(-50%);
    width:80px; height:60px; background:#c1272d;
  }
  .sleeve{
    position:absolute; top:118px; width:24px; height:30px; background:#c1272d;
  }
  .sleeve.left{ left:28px; }
  .sleeve.right{ right:28px; }

  .arm{
    position:absolute; top:148px; width:20px; height:48px; background:#f1c7a6;
  }
  .arm.left{ left:30px; }
  .arm.right{ right:30px; }

  .pants{
    position:absolute; top:188px; left:50%; transform:translateX(-50%);
    width:82px; height:46px; background:#0e0e18;
  }
  .shoes{
    position:absolute; top:232px; left:50%; transform:translateX(-50%);
    width:74px; height:12px; background:#fff;
  }

  /* Controls */
  .controls{
    display:flex;
    justify-content:center;
    gap:14px;
    margin-top:12px;
  }

  .btn{
    width:140px;
    padding:14px 0;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.22);
    background:rgba(255,255,255,0.10);
    color:#fff;
    font-weight:1000;
    font-size:16px;
    letter-spacing:0.6px;
    text-align:center;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active{ transform:scale(0.98); }

  /* success overlay */
  .overlay{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    padding:20px;
    background:rgba(0,0,0,0.55);
  }
  .overlay.show{ display:flex; }
  .modal{
    width:min(360px, 92vw);
    border-radius:18px;
    padding:18px 16px;
    background:rgba(255,255,255,0.10);
    border:1px solid rgba(255,255,255,0.16);
    text-align:center;
  }
  .modal h2{ margin:0 0 8px; font-size:22px; font-weight:1000; }
  .modal p{ margin:0 0 14px; opacity:0.9; }
  .next{
    width:100%;
    padding:14px 0;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.22);
    background:rgba(255,255,255,0.12);
    color:#fff;
    font-weight:1000;
    font-size:16px;
  }
  .next:active{ transform:scale(0.98); }

  @media (max-height: 720px){
    h1{ font-size:24px; }
    .gameCard{ padding:12px; }
  }
</style>
</head>

<body>
<div class="wrap">
  <h1>First Stop: Tampines üè°</h1>
  <div class="sub">Turn left/right to get outside of the house.</div>

  <div class="gameCard">
    <div class="hudRow">
      <div class="hint">You always walk forward. You only steer ‚¨ÖÔ∏è ‚û°Ô∏è</div>
      <div class="badge" id="steps">0 moves</div>
    </div>

    <div class="stage" id="stage">
      <canvas id="cv" width="240" height="320"></canvas>

      <div class="miniAgyTag" id="miniTag">agy96</div>

      <div class="miniAgy" id="miniAgy">
        <div class="pixel">
          <div class="hair"></div>
          <div class="face"></div>

          <div class="glasses">
            <div class="side"></div>
            <div class="lens"></div>
            <div class="bridge"></div>
            <div class="lens"></div>
            <div class="side"></div>
          </div>

          <div class="body"></div>
          <div class="sleeve left"></div>
          <div class="sleeve right"></div>

          <div class="arm left"></div>
          <div class="arm right"></div>

          <div class="pants"></div>
          <div class="shoes"></div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="btn" id="leftBtn">‚¨ÖÔ∏è Left</div>
      <div class="btn" id="rightBtn">Right ‚û°Ô∏è</div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <h2>You found it! üó∫Ô∏è</h2>
    <p>Map unlocked. Next up: choose your destination.</p>
    <button class="next" id="nextBtn">Go to Map</button>
  </div>
</div>

<!-- BGM -->
<audio id="bgm" src="./arcade.mp3" loop></audio>

<script>
/* =========================
   BGM (will play after first user tap on mobile)
========================= */
const bgm = document.getElementById("bgm");
bgm.volume = 0.5;
function tryPlayBgm(){
  bgm.play().then(()=>localStorage.setItem("bgmPlaying","true")).catch(()=>{});
}
if (localStorage.getItem("bgmPlaying")==="true") tryPlayBgm();

/* =========================
   Maze that "makes sense" with your mechanic:
   - auto-walk DOWN
   - player steers LEFT/RIGHT
   - path is guaranteed solvable WITHOUT needing to go up
========================= */
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");

const TILE = 16;
const COLS = 15;  // 240/16
const ROWS = 20;  // 320/16

// 1 = wall/hedge, 0 = path
const maze = Array.from({length: ROWS}, ()=> Array(COLS).fill(1));

function carve(x,y){
  if (x<=0 || x>=COLS-1 || y<=0 || y>=ROWS-1) return;
  maze[y][x]=0;
}

// Build a guaranteed downward-only main path + some side branches
function buildMaze(){
  // Start
  let x = 1, y = 1;
  carve(x,y);

  // Main path to bottom (down + sideways only)
  while (y < ROWS-2){
    // always go down at least 1
    const downSteps = 1 + Math.floor(Math.random()*2); // 1-2
    for(let i=0;i<downSteps && y<ROWS-2;i++){
      y += 1;
      carve(x,y);
    }

    // random sideways corridor
    const dir = Math.random()<0.5 ? -1 : 1;
    const sideLen = Math.floor(Math.random()*4); // 0-3
    for(let i=0;i<sideLen;i++){
      const nx = x + dir;
      if (nx<=1 || nx>=COLS-2) break;
      x = nx;
      carve(x,y);
    }
  }

  // Exit near wherever we ended
  EXIT.x = x;
  EXIT.y = ROWS-1;
  // open bottom row exit and the cell above it
  maze[ROWS-1][x] = 0;
  maze[ROWS-2][x] = 0;

  // Add some downward-only branches
  for(let b=0;b<10;b++){
    const by = 2 + Math.floor(Math.random()*(ROWS-5));
    const bx = 1 + Math.floor(Math.random()*(COLS-2));
    if (maze[by][bx]!==0) continue;

    // branch sideways then down
    const bdir = Math.random()<0.5 ? -1 : 1;
    let tx = bx, ty = by;

    const sideways = 1 + Math.floor(Math.random()*4);
    for(let i=0;i<sideways;i++){
      const nx = tx + bdir;
      if (nx<=1 || nx>=COLS-2) break;
      tx = nx;
      carve(tx,ty);
    }

    const down = 1 + Math.floor(Math.random()*5);
    for(let i=0;i<down && ty<ROWS-2;i++){
      ty += 1;
      carve(tx,ty);
    }
  }

  // Ensure borders are walls (except exit we opened)
  for(let xx=0;xx<COLS;xx++){
    maze[0][xx]=1;
    maze[ROWS-1][xx]= (xx===EXIT.x ? 0 : 1);
  }
  for(let yy=0;yy<ROWS;yy++){
    maze[yy][0]=1;
    maze[yy][COLS-1]=1;
  }
}

// Exit position (filled after build)
const EXIT = { x: 13, y: ROWS-1 };
buildMaze();

// Player start
let p = { x: 1, y: 1 };
let moves = 0;
let won = false;

const stepsEl = document.getElementById("steps");
const overlay = document.getElementById("overlay");
const stage = document.getElementById("stage");
const mini = document.getElementById("miniAgy");
const miniTag = document.getElementById("miniTag");

function inBounds(x,y){ return x>=0 && y>=0 && x<COLS && y<ROWS; }
function isWall(x,y){ return !inBounds(x,y) || maze[y][x]===1; }

function setMoves(){ stepsEl.textContent = `${moves} moves`; }

function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);

  // grass base
  ctx.fillStyle = "#2f8f3b";
  ctx.fillRect(0,0,cv.width,cv.height);

  // walls / hedges
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      if(maze[y][x]===1){
        ctx.fillStyle = "#1f6a2b";
        ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
        ctx.fillStyle = "rgba(255,255,255,0.06)";
        ctx.fillRect(x*TILE,y*TILE,TILE,3);
      } else {
        if ((x+y)%7===0){
          ctx.fillStyle = "rgba(255,255,255,0.08)";
          ctx.fillRect(x*TILE+6,y*TILE+6,2,2);
        }
      }
    }
  }

  // exit emoji
  ctx.font = "14px system-ui";
  ctx.fillText("üó∫Ô∏è", EXIT.x*TILE+1, EXIT.y*TILE+14);

  // vignette
  const g = ctx.createLinearGradient(0,0,0,cv.height);
  g.addColorStop(0,"rgba(0,0,0,0.10)");
  g.addColorStop(1,"rgba(0,0,0,0.22)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,cv.width,cv.height);
}

function positionMini(){
  const rect = stage.getBoundingClientRect();
  const canvasW = cv.width, canvasH = cv.height;

  const scaleX = rect.width / canvasW;
  const scaleY = rect.height / canvasH;

  // center on tile
  const px = (p.x*TILE + TILE/2) * scaleX;
  const py = (p.y*TILE + TILE/2) * scaleY;

  mini.style.left = px + "px";
  mini.style.top  = py + "px";

  // tag above
  miniTag.style.left = px + "px";
  miniTag.style.top  = (py - 36) + "px";
}

function checkWin(){
  if (p.x===EXIT.x && p.y===EXIT.y){
    won = true;
    overlay.classList.add("show");
  }
}

// move left/right
function tryMove(dx){
  if (won) return;
  const nx = p.x + dx;
  const ny = p.y;
  if (!isWall(nx,ny)){
    p.x = nx;
    moves++;
    setMoves();
    draw();
    positionMini();
    checkWin();
  }
}

// auto-walk forward (down)
function autoForward(){
  if (won) return;
  const nx = p.x;
  const ny = p.y + 1;
  if (!isWall(nx,ny)){
    p.y = ny;
    moves++;
    setMoves();
    draw();
    positionMini();
    checkWin();
  }
  // if blocked, user must steer
}

// Controls
document.getElementById("leftBtn").addEventListener("click", () => { tryPlayBgm(); tryMove(-1); });
document.getElementById("rightBtn").addEventListener("click", () => { tryPlayBgm(); tryMove(1); });

window.addEventListener("keydown", (e)=>{
  if (e.key==="ArrowLeft") tryMove(-1);
  if (e.key==="ArrowRight") tryMove(1);
});

// Start
draw();
setMoves();
positionMini();
setInterval(autoForward, 360);

// Next
document.getElementById("nextBtn").addEventListener("click", ()=>{
  location.href = "./map.html";
});
</script>
</body>
</html>
