<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Welcome to Chinatown!</title>

<style>
  :root{
    --maxw: 420px;
    --stroke: rgba(255,255,255,0.14);
  }

  html,body{
    margin:0;height:100%;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:#fff;
    background:
      radial-gradient(900px 520px at 50% 22%, rgba(120,255,235,0.12), transparent 62%),
      radial-gradient(900px 520px at 50% 78%, rgba(160,120,255,0.10), transparent 62%),
      linear-gradient(160deg,#06202a,#070714);
  }

  .wrap{
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    padding:16px 14px 14px;
    box-sizing:border-box;
  }

  h1{
    margin:6px 0 6px;
    font-weight:1000;
    letter-spacing:-0.5px;
    font-size:26px;
    text-align:center;
  }

  .sub{
    margin:0 0 8px;
    opacity:0.86;
    text-align:center;
    font-size:13px;
    line-height:1.25;
  }

  .hint{
    margin:0 0 10px;
    opacity:0.75;
    text-align:center;
    font-size:12px;
  }

  /* Hide title/subtitle/hint when win scene shows */
  .titleBlock.hide{ display:none; }

  .hud{
    width:min(var(--maxw), 94vw);
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin:6px 0 10px;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:rgba(0,0,0,0.20);
    backdrop-filter: blur(6px);
    box-shadow: 0 10px 24px rgba(0,0,0,0.18);
    font-weight:1000;
    font-size:12px;
  }

  .stageCard{
    width:min(var(--maxw), 94vw);
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    border-radius:18px;
    padding:12px;
    box-sizing:border-box;
  }

  .stage{
    position:relative;
    width:100%;
    aspect-ratio: 3 / 4;
    border-radius:14px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.10);
    background:
      radial-gradient(120% 120% at 50% 30%, rgba(255,255,255,0.10) 0%, rgba(0,0,0,0.10) 65%, rgba(0,0,0,0.18) 100%),
      linear-gradient(180deg, rgba(255,80,120,0.07), rgba(0,0,0,0.00)),
      linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0.06));
  }

  /* subtle lantern glow dots */
  .stage:before{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(10px 10px at 18% 16%, rgba(255,180,80,0.18), transparent 60%),
      radial-gradient(10px 10px at 82% 14%, rgba(255,80,120,0.16), transparent 60%),
      radial-gradient(12px 12px at 62% 22%, rgba(255,180,80,0.12), transparent 60%),
      radial-gradient(10px 10px at 40% 12%, rgba(255,80,120,0.12), transparent 60%);
    pointer-events:none;
    opacity:0.85;
  }

  canvas{
    width:100%;
    height:100%;
    display:block;
    image-rendering:pixelated;
  }

  /* Win scene */
  .winWrap{
    width:min(var(--maxw), 94vw);
    display:none;
    flex-direction:column;
    align-items:center;
    gap:14px;
    margin-top:10px;
  }
  .winWrap.show{ display:flex; }

  .winText{
    width:min(var(--maxw), 94vw);
    text-align:center;
    font-weight:1000;
    font-size:16px;
    line-height:1.25;
  }

  .eatStage{
    width:min(var(--maxw), 94vw);
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    border-radius:18px;
    padding:12px;
    box-sizing:border-box;
  }
  .eatBox{
    position:relative;
    width:100%;
    aspect-ratio: 3 / 2;
    border-radius:14px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.10);
    background:
      radial-gradient(120% 120% at 50% 30%, rgba(255,255,255,0.10) 0%, rgba(0,0,0,0.10) 65%, rgba(0,0,0,0.18) 100%),
      linear-gradient(180deg, rgba(255,80,120,0.06), rgba(0,0,0,0.00));
  }

  .btn{
    width:min(var(--maxw), 94vw);
    padding:16px 18px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.22);
    background:rgba(255,255,255,0.10);
    color:#fff;
    font-weight:1000;
    font-size:16px;
    letter-spacing:0.4px;
  }
  .btn:active{ transform:scale(0.98); }

  .gameWrap.hide{ display:none; }

  @media (max-width: 360px){
    h1{ font-size:24px; }
    .sub{ font-size:12px; }
    .pill{ font-size:11px; }
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="titleBlock" id="titleBlock">
    <h1>Welcome to Chinatown! üèÆ</h1>
    <div class="sub">Catch your 10 mala ingredients to win! And avoid the bombs.</div>
    <div class="hint">Tap anywhere to move in the direction you want.</div>
  </div>

  <div class="hud gameWrap" id="gameHud">
    <div class="pill">ü•¢ Ingredients: <span id="score">0</span> / 10</div>
    <div class="pill">üí• Bomb hits: <span id="hits">0</span></div>
  </div>

  <div class="stageCard gameWrap" id="gameWrap">
    <div class="stage">
      <canvas id="game" width="360" height="480" aria-label="Chinatown falling ingredients game"></canvas>
    </div>
  </div>

  <!-- WIN SCENE -->
  <div class="winWrap" id="winWrap">
    <div class="winText">Congrats! Let‚Äôs get you full before your adventure continues.</div>
    <div class="eatStage">
      <div class="eatBox">
        <canvas id="eat" width="360" height="240" aria-label="agy96 eating scene"></canvas>
      </div>
    </div>
    <button class="btn" id="fullBtn">Click when you‚Äôre full</button>
  </div>

</div>

<audio id="bgm" src="./arcade.mp3" loop></audio>

<script>
/* =========================
   SETTINGS YOU CAN EDIT
========================= */
const MAP_FILE = "./map.html";
const NEXT_PROMPT_INDEX = 1; // 1 = MacRitchie
const WIN_TARGET = 10;

/* =========================
   BGM
========================= */
const bgm = document.getElementById("bgm");
bgm.volume = 0.5;
function tryPlayBgm(){
  bgm.play().then(()=>localStorage.setItem("bgmPlaying","true")).catch(()=>{});
}
if (localStorage.getItem("bgmPlaying")==="true") tryPlayBgm();

/* =========================
   GAME CANVAS
========================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const scoreEl = document.getElementById("score");
const hitsEl  = document.getElementById("hits");
const gameWrap = document.getElementById("gameWrap");
const gameHud  = document.getElementById("gameHud");
const titleBlock = document.getElementById("titleBlock");

const winWrap = document.getElementById("winWrap");
const fullBtn = document.getElementById("fullBtn");

let running = true;
let score = 0;
let bombHits = 0;
let shake = 0;

const W = canvas.width;
const H = canvas.height;

/* Player (size matches your ‚Äúgood earlier version‚Äù) */
const player = {
  x: W/2,
  y: H - 52,
  tx: W/2,
  w: 26,
  h: 44
};

const drops = [];
let spawnTimer = 0;

const TYPES = [
  { kind:"ingredient", name:"cabbage" },
  { kind:"ingredient", name:"mushroom" },
  { kind:"ingredient", name:"beef" },
  { kind:"ingredient", name:"tofu" },
  { kind:"ingredient", name:"lotus" },
  { kind:"ingredient", name:"chili" },
  { kind:"bomb",       name:"bomb" }
];

function rand(min,max){ return Math.random()*(max-min)+min; }
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

function spawn(){
  const isBomb = Math.random() < 0.20;
  const pick = isBomb ? TYPES.find(x=>x.name==="bomb") : TYPES[Math.floor(rand(0,6))];
  drops.push({
    kind: pick.kind,
    name: pick.name,
    x: rand(18, W-18),
    y: -20,
    vy: rand(1.6, 2.4) + Math.min(1.2, score*0.06),
    rot: rand(0, Math.PI*2),
    vr: rand(-0.04, 0.04)
  });
}

function rectHit(ax,ay,aw,ah, bx,by,bw,bh){
  return ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by;
}

/* =========================
   BACKGROUND
========================= */
function bg(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "rgba(0,0,0,0.10)";
  ctx.fillRect(0, H-70, W, 70);

  ctx.globalAlpha = 0.9;
  ctx.fillStyle = "rgba(255,255,255,0.14)";
  ctx.fillRect(0, 24, W, 2);
  ctx.globalAlpha = 1;

  for(let i=0;i<6;i++){
    const lx = 30 + i*55;
    drawLantern(lx, 34, 1);
  }
}

function drawLantern(x,y,s){
  ctx.save();
  ctx.translate(x,y);
  ctx.scale(s,s);
  ctx.fillStyle="rgba(255,255,255,0.18)";
  ctx.fillRect(-1,-12,2,12);
  ctx.fillStyle="#d22b2b";
  ctx.fillRect(-10,-2,20,18);
  ctx.fillStyle="#b01f1f";
  ctx.fillRect(-12,1,4,12);
  ctx.fillRect(8,1,4,12);
  ctx.fillStyle="#f2c94c";
  ctx.fillRect(-6,4,12,2);
  ctx.fillRect(-6,9,12,2);
  ctx.fillStyle="#d1b15a";
  ctx.fillRect(-2,16,4,10);
  ctx.fillStyle="#d22b2b";
  ctx.fillRect(-5,26,10,3);
  ctx.restore();
}

/* =========================
   GLASSES (single source of truth)
   draws: --[]-[]-- with bridge + temple arms
========================= */
function drawGlasses(g, x, y, lensW, lensH, thick, gap, armLen){
  g.fillStyle = "#000";

  // left lens
  g.fillRect(x, y, lensW, thick);
  g.fillRect(x, y, thick, lensH);
  g.fillRect(x, y + lensH - thick, lensW, thick);
  g.fillRect(x + lensW - thick, y, thick, lensH);

  // right lens
  const rx = x + lensW + gap;
  g.fillRect(rx, y, lensW, thick);
  g.fillRect(rx, y, thick, lensH);
  g.fillRect(rx, y + lensH - thick, lensW, thick);
  g.fillRect(rx + lensW - thick, y, thick, lensH);

  // bridge (centered on lens midline)
  const armY = y + Math.floor(lensH / 2); // <-- use midline for arms AND bridge
  const bridgeW = Math.max(3, gap - 1);
  g.fillRect(x + lensW, armY, bridgeW, 2);

  // temple arms (same midline so you always see the ‚Äú--‚Äù)
  g.fillRect(x - armLen, armY, armLen, 2);
  g.fillRect(rx + lensW, armY, armLen, 2);
}

/* =========================
   GAMEPLAY AVATAR (small + plate)
   - same ‚Äúold good‚Äù proportions
   - fixes: glasses arms + higher position
   - fixes: not sleeveless (adds sleeves)
========================= */
function drawAgyGameplay(px, py){
  const x = px, y = py;

  // hair (simple rectangular blob like you want)
  ctx.fillStyle="#000";
  ctx.fillRect(x-18, y-60, 36, 60);

  // face
  ctx.fillStyle="#f1c7a6";
  ctx.fillRect(x-12, y-44, 24, 28);

  // glasses (nudge right + shorter temple arms so it stays on the face)
  const gy = y - 38;
  const lensW = 11, lensH = 9;
  const thick = 2, gap = 5, armLen = 4;   // <-- armLen reduced
  const leftX = x - 14;                   // <-- moved right (was x-16)
  drawGlasses(ctx, leftX, gy, lensW, lensH, thick, gap, armLen);

  // shirt
  ctx.fillStyle="#c1272d";
  ctx.fillRect(x-16, y-16, 32, 22);

  // sleeves (so it‚Äôs not sleeveless)
  ctx.fillRect(x-22, y-16, 6, 8);
  ctx.fillRect(x+16, y-16, 6, 8);

  // arms
  ctx.fillStyle="#f1c7a6";
  ctx.fillRect(x-22, y-8, 6, 10);
  ctx.fillRect(x+16, y-8, 6, 10);

  // plate
  ctx.fillStyle="rgba(255,255,255,0.92)";
  ctx.fillRect(x-10, y-2, 20, 6);
  ctx.fillStyle="rgba(0,0,0,0.08)";
  ctx.fillRect(x-8, y-1, 16, 2);

  // pants + shoes
  ctx.fillStyle="#0e0e18";
  ctx.fillRect(x-16, y+6, 32, 16);

  ctx.fillStyle="#fff";
  ctx.fillRect(x-14, y+22, 28, 5);
}

/* =========================
   FALLING OBJECTS
========================= */
function drawDrop(d){
  ctx.save();
  ctx.translate(d.x, d.y);
  ctx.rotate(d.rot);

  if(d.kind === "bomb"){
    ctx.fillStyle="#222";
    ctx.fillRect(-12,-10,24,20);
    ctx.fillStyle="#111";
    ctx.fillRect(-10,-8,20,16);
    ctx.fillStyle="#888";
    ctx.fillRect(-4,-16,8,6);
    ctx.fillStyle="#f2c94c";
    ctx.fillRect(4,-16,6,3);
    ctx.fillStyle="#ff5b5b";
    ctx.fillRect(10,-17,3,3);
  } else {
    if(d.name==="cabbage"){
      ctx.fillStyle="#5ecb6a"; ctx.fillRect(-12,-12,24,24);
      ctx.fillStyle="#7fe68a"; ctx.fillRect(-6,-10,12,20);
      ctx.fillStyle="#43a754"; ctx.fillRect(-10,-6,20,12);
    }
    if(d.name==="mushroom"){
      ctx.fillStyle="#c94b4b"; ctx.fillRect(-14,-12,28,16);
      ctx.fillStyle="#fff";    ctx.fillRect(-8,-6,4,4);
      ctx.fillRect(0,-8,4,4);
      ctx.fillRect(6,-4,4,4);
      ctx.fillStyle="#e8d8c2"; ctx.fillRect(-6,4,12,14);
      ctx.fillStyle="#000";    ctx.fillRect(-14,-12,28,2);
    }
    if(d.name==="beef"){
      ctx.fillStyle="#b44949"; ctx.fillRect(-12,-10,24,20);
      ctx.fillStyle="#f1c7a6"; ctx.fillRect(-10,-6,6,12);
      ctx.fillStyle="#7a2e2e"; ctx.fillRect(-2,-8,12,16);
      ctx.fillStyle="#000";    ctx.fillRect(-12,-10,24,2);
    }
    if(d.name==="tofu"){
      ctx.fillStyle="#f2f2f2"; ctx.fillRect(-12,-12,24,24);
      ctx.fillStyle="#d8d8d8"; ctx.fillRect(-12,8,24,4);
      ctx.fillStyle="#b6e4c3"; ctx.fillRect(-6,-6,4,4);
      ctx.fillRect(2,0,4,4);
    }
    if(d.name==="lotus"){
      ctx.fillStyle="#f6d1c9"; ctx.fillRect(-12,-12,24,24);
      ctx.fillStyle="#eab2a7"; ctx.fillRect(-8,-8,16,16);
      ctx.fillStyle="#f6d1c9";
      ctx.fillRect(-5,-5,3,3);
      ctx.fillRect(2,-4,3,3);
      ctx.fillRect(-1,2,3,3);
    }
    if(d.name==="chili"){
      ctx.fillStyle="#ff3b3b"; ctx.fillRect(-12,-6,24,12);
      ctx.fillStyle="#b01f1f"; ctx.fillRect(-6,-8,12,16);
      ctx.fillStyle="#43a754"; ctx.fillRect(10,-10,4,6);
    }
  }
  ctx.restore();
}

/* =========================
   INPUT
========================= */
function onTap(clientX){
  tryPlayBgm();
  const rect = canvas.getBoundingClientRect();
  const x = (clientX - rect.left) * (canvas.width / rect.width);
  player.tx = clamp(x, 20, W-20);
}

canvas.addEventListener("mousedown", (e)=> onTap(e.clientX));
canvas.addEventListener("touchstart", (e)=>{
  const t = e.touches[0];
  onTap(t.clientX);
}, {passive:true});

/* =========================
   LOOP
========================= */
function step(){
  if(!running) return;

  // spawn
  spawnTimer++;
  if(spawnTimer > 28){
    spawnTimer = 0;
    spawn();
  }

  // player easing
  player.x += (player.tx - player.x) * 0.18;

  // update drops
  for(let i=drops.length-1;i>=0;i--){
    const d = drops[i];
    d.y += d.vy;
    d.rot += d.vr;

    const pBox = { x: player.x - player.w/2, y: player.y - player.h, w: player.w, h: player.h };
    const dBox = { x: d.x - 14, y: d.y - 14, w: 28, h: 28 };

    if(rectHit(pBox.x,pBox.y,pBox.w,pBox.h, dBox.x,dBox.y,dBox.w,dBox.h)){
      drops.splice(i,1);

      if(d.kind === "bomb"){
        bombHits++;
        hitsEl.textContent = bombHits;
        shake = 10;
        score = Math.max(0, score-1);
        scoreEl.textContent = score;
      } else {
        score++;
        scoreEl.textContent = score;
        if(score >= WIN_TARGET){
          win();
          return;
        }
      }
    } else if(d.y > H + 30){
      drops.splice(i,1);
    }
  }

  // draw
  ctx.save();
  if(shake>0){
    shake *= 0.85;
    ctx.translate(rand(-shake, shake), rand(-shake, shake));
  }

  bg();
  for(const d of drops) drawDrop(d);
  drawAgyGameplay(player.x, player.y);

  ctx.restore();
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

/* =========================
   WIN FLOW
========================= */
function win(){
  running = false;
  gameWrap.classList.add("hide");
  gameHud.classList.add("hide");
  titleBlock.classList.add("hide");
  winWrap.classList.add("show");
  startEatingScene();
}

/* =========================
   EATING SCENE (keep old vibe)
   - restore full avatar
   - only change glasses to --[]-[]--
   - utensil closer to hand
========================= */
const eatCanvas = document.getElementById("eat");
const eatCtx = eatCanvas.getContext("2d");
let eatTick = 0;

function drawTextLabel(g, text, x, y){
  g.save();
  g.font = "900 14px system-ui, -apple-system, Segoe UI, Roboto, Arial"; // smaller
  g.textAlign = "center";
  g.fillStyle = "rgba(0,0,0,0.35)";
  g.fillText(text, x+2, y+2);
  g.fillStyle = "#fff";
  g.fillText(text, x, y);
  g.restore();
}


function drawAgyEating(g, cx, cy){
  // hair (old look)
  g.fillStyle="#000";
  g.fillRect(cx-20, cy-70, 40, 60);

  // face
  g.fillStyle="#f1c7a6";
  g.fillRect(cx-14, cy-56, 28, 28);

  // glasses (old-size, but with temple arms + bridge)
  const lensW = 12, lensH = 9;
  const thick = 2, gap = 5, armLen = 7;
  const gy = cy - 50;     // keep nice placement
  const leftX = cx - 18;
  drawGlasses(g, leftX, gy, lensW, lensH, thick, gap, armLen);

  // shirt
  g.fillStyle="#c1272d";
  g.fillRect(cx-18, cy-28, 36, 22);

  // arm (towards utensil)
  g.fillStyle="#f1c7a6";
  g.fillRect(cx+18, cy-18, 10, 10);
}

function drawEating(){
  eatTick++;

  const W2 = eatCanvas.width;
  const H2 = eatCanvas.height;
  eatCtx.clearRect(0,0,W2,H2);

  // table
  eatCtx.fillStyle="rgba(0,0,0,0.20)";
  eatCtx.fillRect(0, H2-60, W2, 60);

  // plate
  eatCtx.fillStyle="rgba(255,255,255,0.92)";
  eatCtx.fillRect(W2/2-60, H2-78, 120, 18);
  eatCtx.fillStyle="rgba(0,0,0,0.10)";
  eatCtx.fillRect(W2/2-52, H2-72, 104, 6);

  // food dots
  for(let i=0;i<10;i++){
    eatCtx.fillStyle = i%2? "#ff5b5b":"#57b15f";
    eatCtx.fillRect(W2/2-45 + (i*9), H2-74 + (i%3), 4, 4);
  }

  const cx = W2/2;
  const cy = H2-84;

  // label (no pill)
  drawTextLabel(eatCtx, "agy96", cx, cy-92);

  // avatar (restored)
  drawAgyEating(eatCtx, cx, cy);

  // utensil (closer to hand)
  const bob = Math.sin(eatTick*0.18) * 6;
  eatCtx.fillStyle="#d1b15a";
  eatCtx.fillRect(cx+22, cy-22 + bob, 4, 18);   // moved from +40 to +30
  eatCtx.fillStyle="#fff";
  eatCtx.fillRect(cx+20, cy-28 + bob, 8, 6);

  if(winWrap.classList.contains("show")){
    requestAnimationFrame(drawEating);
  }
}

function startEatingScene(){
  drawEating();
}

/* =========================
   BUTTON: back to map
========================= */
fullBtn.addEventListener("click", ()=>{
  localStorage.setItem("mapPromptIndex", String(NEXT_PROMPT_INDEX));
  location.href = MAP_FILE;
});
</script>
</body>
</html>
