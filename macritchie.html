<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MacRitchie Hike</title>
  <style>
    :root{
      --cardBg1: rgba(7, 24, 28, 0.74);
      --cardBg2: rgba(5, 18, 22, 0.70);
      --border: rgba(255,255,255,0.12);
      --text: #eaf6ff;
      --muted: rgba(234,246,255,0.78);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 50% -10%, #123d45, #06161a);
      color: var(--text);
    }
    .wrap{
      min-height:100svh;
      display:flex;
      justify-content:center;
      padding: 18px 14px 24px;
    }
    .card{
      width:min(560px, 100%);
      border-radius: 26px;
      background: linear-gradient(180deg, var(--cardBg1), var(--cardBg2));
      border: 1px solid var(--border);
      box-shadow: 0 30px 80px rgba(0,0,0,0.55);
      overflow:hidden;
    }
    .page{ display:none; }
    .page.active{ display:block; }

    .header{
      padding: 22px 18px 12px;
      text-align:center;
    }
    h1{
      margin: 0 0 6px;
      font-size: 34px;
      line-height: 1.08;
      font-weight: 900;
      letter-spacing: -0.02em;
      text-shadow: 0 2px 10px rgba(0,0,0,0.35);
    }
    .sub{
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .hud{
      display:flex;
      gap: 10px;
      justify-content: space-between;
      padding: 0 16px 12px;
    }
    .pill{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border-radius: 999px;
      padding: 12px 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 800;
      letter-spacing: 0.2px;
      min-width: 0;
    }
    .pill small{
      color: var(--muted);
      font-weight: 700;
    }

    .stage{ padding: 10px 14px 16px; }
    .frame{
      border-radius: 22px;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 10px;
    }
    canvas{
      width:100%;
      height:auto;
      display:block;
      border-radius: 18px;
      background: #dff3ff;
      touch-action: manipulation;
    }

    .footer{
      padding: 14px 16px 20px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:center;
      flex-wrap: wrap;
    }
    .btn{
      appearance:none;
      border: 0;
      border-radius: 999px;
      padding: 14px 16px;
      font-weight: 900;
      letter-spacing: 0.2px;
      background: rgba(255,255,255,0.10);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.16);
      cursor:pointer;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(159,240,200,0.22), rgba(159,240,200,0.12));
      border: 1px solid rgba(159,240,200,0.28);
    }
    .btn:active{ transform: translateY(1px); }
    .hint{
      width: 100%;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .viewWrap{ padding: 14px; }
    .viewTitle{
      text-align:center;
      font-weight: 900;
      font-size: 22px;
      margin: 6px 0 8px;
      letter-spacing: -0.01em;
    }
    .viewSubtitle{
      text-align:center;
      color: var(--muted);
      margin: 0 0 12px;
      font-size: 13px;
    }
    .viewFrame{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.10);
      overflow:hidden;
      background: rgba(0,0,0,0.16);
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <!-- GAME PAGE -->
    <section id="gamePage" class="page active">
      <div class="header">
        <h1>Welcome to the MacRitchie hike! ðŸ¥¾</h1>
        <p class="sub">Tap to jump onto the logs.<br/>Land on 10 logs to reach the top.</p>
      </div>

      <div class="hud">
        <div class="pill"><span>ðŸªµ</span><span>Logs:&nbsp;<strong id="logsCount">0</strong>&nbsp;<small>/ 10</small></span></div>
        <div class="pill"><span>ðŸ™ˆ</span><span>Slips:&nbsp;<strong id="slipsCount">0</strong></span></div>
      </div>

      <div class="stage">
        <div class="frame">
          <canvas id="game" width="390" height="560" aria-label="MacRitchie hike game"></canvas>
        </div>
      </div>

      <div class="footer">
        <button id="startBtn" class="btn primary">Start</button>
        <button id="resetBtn" class="btn">Reset</button>
        <div class="hint">Tap when your avatar is aligned with the next moving log.</div>
      </div>
    </section>

    <!-- VIEW PAGE -->
    <section id="viewPage" class="page">
      <div class="viewWrap">
        <div class="viewTitle">Enjoy the view, you deserve it! ðŸŒ…</div>
        <div class="viewSubtitle">MacRitchie complete â€” you made it to the top.</div>

        <div class="viewFrame">
          <canvas id="view" width="390" height="460" aria-label="View scene"></canvas>
        </div>

        <div class="footer" style="padding-top:14px;">
          <button id="nextBtn" class="btn primary">Iâ€™m ready for my next adventure!</button>
          <button id="replayBtn" class="btn">Replay MacRitchie</button>
        </div>
      </div>
    </section>

  </div>
</div>

<script>
(() => {
  // ===== DOM =====
  const gamePage = document.getElementById("gamePage");
  const viewPage = document.getElementById("viewPage");

  const logsCountEl = document.getElementById("logsCount");
  const slipsCountEl = document.getElementById("slipsCount");

  const startBtn = document.getElementById("startBtn");
  const resetBtn = document.getElementById("resetBtn");
  const replayBtn = document.getElementById("replayBtn");
  const nextBtn = document.getElementById("nextBtn");

  // ===== CANVAS =====
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = true;

  const viewCanvas = document.getElementById("view");
  const vctx = viewCanvas.getContext("2d");
  vctx.imageSmoothingEnabled = true;

  // ===== GAME CONFIG =====
  const GOAL = 10;

  // Shorter logs (you asked shorter length)
  const LOG_W = 88;
  const LOG_H = 14;

  // Upward spacing between logs (controls "hike" feel)
  const LOG_GAP_Y = 68;

  // Avatar size (keep consistent with your Chinatown-style chunky avatar)
  const AVATAR_W = 44;
  const AVATAR_H = 72;

  // Camera / world
  const world = {
    running: false,
    state: "idle",       // idle | playing | falling | win
    t: 0,
    landed: 0,
    slips: 0,
    currentIndex: 0,     // next log to land on
    camY: 0,             // camera offset
    camTargetY: 0,
    shake: 0,
  };

  // Avatar (centered X like a timing game, like your existing mini-games)
  const player = {
    x: canvas.width * 0.5,
    y: 0,                // will be placed at start
    vy: 0,
    onLogY: 0,
    // Colors (tweak if Chinatown avatar uses different palette)
    hair: "#2b1f17",
    skin: "#f0c7a6",
    shirt: "#d64a4a",
    pants: "#1d1f25",
    shoe: "#ffffff"
  };

  let logs = [];
  let birds = [];

  // ===== HELPERS =====
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const rand = (a,b)=>a + Math.random()*(b-a);
  const randi = (a,b)=>Math.floor(rand(a,b));

  function setHUD(){
    logsCountEl.textContent = String(world.landed);
    slipsCountEl.textContent = String(world.slips);
  }

  function goToViewPage(){
    gamePage.classList.remove("active");
    viewPage.classList.add("active");
  }
  function goToGamePage(){
    viewPage.classList.remove("active");
    gamePage.classList.add("active");
  }

  // ===== SETUP =====
  function resetGame(){
    world.running = false;
    world.state = "idle";
    world.t = 0;
    world.landed = 0;
    world.slips = 0;
    world.currentIndex = 0;
    world.camY = 0;
    world.camTargetY = 0;
    world.shake = 0;

    // Build logs upward. logs[0] is the first target above the start zone.
    logs = [];
    const baseY = canvas.height - 140; // first log near bottom
    for (let i=0;i<GOAL;i++){
      const y = baseY - i * LOG_GAP_Y;
      logs.push({
        x: rand(22, canvas.width - LOG_W - 22),
        y,
        w: LOG_W,
        h: LOG_H,
        dir: Math.random()>0.5 ? 1 : -1,
        sp: rand(0.9, 1.8) + (i*0.03), // slight difficulty ramp
      });
    }

    // Player starts standing on the "ground" slightly below first log
    player.x = canvas.width * 0.5;
    player.y = canvas.height - 88;
    player.vy = 0;

    // Birds (daytime) bob A/B/C like you asked
    birds = Array.from({length: 4}, () => ({
      x: rand(20, canvas.width-20),
      y: rand(60, 170),
      baseY: 0,
      phase: randi(0,3),
      t: 0,
      sp: rand(0.6, 1.1),
      drift: rand(0.08, 0.16)
    }));
    birds.forEach(b => b.baseY = b.y);

    setHUD();
    draw(); // initial frame
  }

  // ===== INPUT =====
  function onTap(){
    if (!world.running) return;
    if (world.state !== "playing") return;
    if (world.currentIndex >= GOAL) return;

    const target = logs[world.currentIndex];

    // Check overlap based on player's X (timing game)
    const pxL = player.x - AVATAR_W/2 + 6;
    const pxR = player.x + AVATAR_W/2 - 6;
    const lxL = target.x;
    const lxR = target.x + target.w;

    const overlap = (pxR > lxL) && (pxL < lxR);

    if (overlap){
      // SUCCESS: move player up onto the log
      player.y = target.y - AVATAR_H + 6;
      world.landed++;
      world.currentIndex++;
      setHUD();

      // Camera should follow upward progression
      // Keep player around lower-mid of screen (like â€œhiking upwardsâ€)
      world.camTargetY = (canvas.height*0.55) - player.y;

      if (world.landed >= GOAL){
        world.state = "win";
        world.running = false;
        setTimeout(() => {
          goToViewPage();
        }, 250);
      }
    } else {
      // MISS -> FALL -> RESTART
      world.slips++;
      setHUD();
      world.state = "falling";
      world.shake = 10;
      player.vy = 6; // start falling velocity
    }
  }

  canvas.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    onTap();
  }, {passive:false});

  // ===== UPDATE LOOP =====
  function update(dt){
    world.t += dt;

    // Logs move side-to-side
    for (const log of logs){
      log.x += log.dir * log.sp;
      if (log.x <= 14){ log.x = 14; log.dir *= -1; }
      if (log.x + log.w >= canvas.width - 14){ log.x = canvas.width - 14 - log.w; log.dir *= -1; }
    }

    // Birds bob A/B/C and drift
    for (const b of birds){
      b.t += dt * b.sp;
      if (b.t >= 18){
        b.t = 0;
        b.phase = (b.phase + 1) % 3;
      }
      const offsets = [-5, 0, 4];
      b.y = b.baseY + offsets[b.phase];
      b.x += b.drift * dt;
      if (b.x > canvas.width + 18) b.x = -18;
    }

    // Falling state
    if (world.state === "falling"){
      player.y += player.vy;
      player.vy += 0.55; // gravity feel

      // If falls below screen -> restart
      if (player.y > canvas.height + 80){
        // restart immediately (you said fall = restart)
        hardRestart();
      }
    }

    // Camera easing
    world.camY += (world.camTargetY - world.camY) * 0.08;

    if (world.shake > 0) world.shake -= 1;
  }

  function hardRestart(){
    // Reset run state but keep slip count (or reset slip too? you asked restart game; keeping slips is still fine visually)
    // If you want slips reset to 0 on restart, uncomment next line:
    // world.slips = 0;

    world.running = true;
    world.state = "playing";
    world.currentIndex = 0;
    world.landed = 0;
    world.camY = 0;
    world.camTargetY = 0;
    setHUD();

    // Re-randomize log positions for a true restart feel
    const baseY = canvas.height - 140;
    for (let i=0;i<GOAL;i++){
      logs[i].x = rand(22, canvas.width - LOG_W - 22);
      logs[i].y = baseY - i * LOG_GAP_Y;
      logs[i].dir = Math.random()>0.5 ? 1 : -1;
      logs[i].sp  = rand(0.9, 1.8) + (i*0.03);
    }

    player.x = canvas.width * 0.5;
    player.y = canvas.height - 88;
    player.vy = 0;
  }

  // ===== DRAWING =====
  function drawDayForestBackground(){
    // Day sky gradient (matches your Image 2 vibe)
    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0, "#c8f0ff");
    g.addColorStop(0.55, "#b7f1d1");
    g.addColorStop(1, "#75c79a");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Distant canopy blobs
    ctx.fillStyle = "rgba(66, 156, 120, 0.26)";
    for (let i=0;i<9;i++){
      ctx.beginPath();
      ctx.ellipse(i*55 + 25, 135 + (i%2)*10, 50, 26, 0, 0, Math.PI*2);
      ctx.fill();
    }

    // Distant vertical trunks
    ctx.fillStyle = "rgba(32, 92, 76, 0.22)";
    for (let x=10; x<canvas.width; x+=48){
      ctx.fillRect(x, 120, 20, canvas.height-120);
    }

    // Mid bushes layer
    ctx.fillStyle = "rgba(55, 155, 105, 0.40)";
    for (let i=0;i<10;i++){
      ctx.beginPath();
      ctx.ellipse(i*44 + 20, 260 + (i%2)*8, 46, 24, 0, 0, Math.PI*2);
      ctx.fill();
    }

    // Foreground trees (2 big trunks like reference)
    drawTree(40, 160, 95, 320);
    drawTree(canvas.width - 135, 155, 95, 330);

    // Ground strip (not visible much, but helps)
    ctx.fillStyle = "rgba(64, 112, 80, 0.50)";
    ctx.fillRect(0, canvas.height-50, canvas.width, 50);
  }

  function drawTree(x, y, w, h){
    // trunk
    ctx.fillStyle = "rgba(149, 101, 72, 0.95)";
    ctx.fillRect(x + w*0.35, y + 80, w*0.28, h - 80);

    // branch left
    ctx.fillRect(x + w*0.18, y + 125, w*0.22, 18);
    // branch right
    ctx.fillRect(x + w*0.58, y + 140, w*0.20, 18);

    // canopy
    ctx.fillStyle = "rgba(74, 168, 100, 0.95)";
    ctx.beginPath(); ctx.ellipse(x + w*0.5, y + 70, w*0.55, 46, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x + w*0.30, y + 85, w*0.45, 40, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x + w*0.70, y + 90, w*0.42, 38, 0, 0, Math.PI*2); ctx.fill();
  }

  function drawBird(b){
    // small flying bird "V"
    ctx.fillStyle = "rgba(0,0,0,0.45)";
    const x = Math.round(b.x);
    const y = Math.round(b.y);
    ctx.fillRect(x, y, 2, 2);
    ctx.fillRect(x-4, y+2, 2, 2);
    ctx.fillRect(x+4, y+2, 2, 2);
  }

  function drawLog(log){
    // wood plank (shorter)
    ctx.fillStyle = "#a76636";
    ctx.fillRect(log.x, log.y, log.w, log.h);

    // underside shadow
    ctx.fillStyle = "rgba(0,0,0,0.22)";
    ctx.fillRect(log.x, log.y + log.h - 4, log.w, 4);

    // subtle grain lines
    ctx.fillStyle = "rgba(255,255,255,0.12)";
    ctx.fillRect(log.x + 10, log.y + 5, log.w - 20, 1);
    ctx.fillRect(log.x + 14, log.y + 9, log.w - 28, 1);
  }

  function drawAvatar(){
    // "Chinatown style" chunky avatar (clean, not tiny pixel)
    const x = player.x - AVATAR_W/2;
    const y = player.y;

    // shadow
    ctx.fillStyle = "rgba(0,0,0,0.20)";
    ctx.fillRect(x + 8, y + AVATAR_H + 8, AVATAR_W - 16, 5);

    // hair
    ctx.fillStyle = player.hair;
    ctx.fillRect(x + 8, y + 4, AVATAR_W - 16, 18);

    // face
    ctx.fillStyle = player.skin;
    ctx.fillRect(x + 10, y + 18, AVATAR_W - 20, 22);

    // glasses
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(x + 12, y + 26, 10, 4);
    ctx.fillRect(x + AVATAR_W - 22, y + 26, 10, 4);
    ctx.fillRect(x + (AVATAR_W/2) - 2, y + 27, 4, 2);

    // shirt
    ctx.fillStyle = player.shirt;
    ctx.fillRect(x + 8, y + 40, AVATAR_W - 16, 22);

    // pants
    ctx.fillStyle = player.pants;
    ctx.fillRect(x + 12, y + 62, 12, 18);
    ctx.fillRect(x + AVATAR_W - 24, y + 62, 12, 18);

    // shoes
    ctx.fillStyle = player.shoe;
    ctx.fillRect(x + 12, y + 78, 12, 4);
    ctx.fillRect(x + AVATAR_W - 24, y + 78, 12, 4);
  }

  function draw(){
    const shakeX = world.shake > 0 ? (Math.random()*6 - 3) : 0;
    const shakeY = world.shake > 0 ? (Math.random()*6 - 3) : 0;

    ctx.save();
    ctx.translate(shakeX, shakeY);

    // Background (no camera)
    drawDayForestBackground();
    birds.forEach(drawBird);

    // Apply camera to logs + avatar (so we actually climb upwards)
    ctx.save();
    ctx.translate(0, world.camY);

    // Logs
    for (const log of logs) drawLog(log);

    // Highlight next target log subtly
    if (world.currentIndex < GOAL){
      const t = logs[world.currentIndex];
      ctx.fillStyle = "rgba(255,255,255,0.18)";
      ctx.fillRect(t.x, t.y - 6, t.w, 3);
    }

    // Avatar
    drawAvatar();

    ctx.restore();
    ctx.restore();
  }

  // ===== GAME LOOP =====
  let last = 0;
  function loop(ts){
    if (!last) last = ts;
    const dt = Math.min(33, ts - last);
    last = ts;

    if (world.running){
      update(dt);
    }
    draw();
    requestAnimationFrame(loop);
  }

  // ===== START / RESET =====
  startBtn.addEventListener("click", ()=>{
    if (world.running) return;
    world.running = true;
    world.state = "playing";
    startBtn.textContent = "Runningâ€¦";
    startBtn.disabled = true;
    startBtn.style.opacity = "0.7";
  });

  resetBtn.addEventListener("click", ()=>{
    startBtn.textContent = "Start";
    startBtn.disabled = false;
    startBtn.style.opacity = "1";
    resetGame();
  });

  replayBtn.addEventListener("click", ()=>{
    goToGamePage();
    startBtn.textContent = "Start";
    startBtn.disabled = false;
    startBtn.style.opacity = "1";
    resetGame();
  });

  nextBtn.addEventListener("click", ()=>{
    // Hook to your next location page
    // window.location.href = "next.html";
    alert("Hook this to your next adventure page.");
  });

  // ===== VIEW PAGE (Dcop-like nice scene) =====
  const view = {
    clouds: [
      { x: -120, y: 70,  s: 1.0, sp: 0.18 },
      { x:  40,  y: 115, s: 0.8, sp: 0.12 },
      { x:  220, y: 85,  s: 0.9, sp: 0.14 }
    ],
    petals: Array.from({length: 24}, () => ({
      x: rand(0, viewCanvas.width),
      y: rand(-30, viewCanvas.height),
      r: rand(4,7),
      sp: rand(0.08, 0.20),
      drift: rand(-0.06, 0.06),
      a: rand(0.10, 0.22)
    }))
  };

  function drawCloud(c, x, y, s){
    c.save();
    c.globalAlpha = 0.92;
    c.fillStyle = "white";
    c.beginPath();
    c.ellipse(x + 40*s, y + 20*s, 40*s, 18*s, 0, 0, Math.PI*2);
    c.ellipse(x + 70*s, y + 18*s, 34*s, 16*s, 0, 0, Math.PI*2);
    c.ellipse(x + 18*s, y + 22*s, 26*s, 14*s, 0, 0, Math.PI*2);
    c.fill();
    c.restore();
  }

  function drawSittingAvatar(c, x, y){
    // same chunky style, but sitting
    // x,y = anchor near grass
    const w = 54, h = 72;

    // head + hair
    c.fillStyle = player.hair;
    c.fillRect(x + 10, y + 6, w - 20, 16);

    c.fillStyle = player.skin;
    c.fillRect(x + 12, y + 20, w - 24, 20);

    // shirt
    c.fillStyle = player.shirt;
    c.fillRect(x + 10, y + 40, w - 20, 18);

    // legs folded
    c.fillStyle = player.pants;
    c.fillRect(x + 12, y + 58, 16, 10);
    c.fillRect(x + 26, y + 62, 20, 10);

    c.fillStyle = "white";
    c.fillRect(x + 26, y + 72, 20, 3);
  }

  let viewLast = 0;
  function viewLoop(ts){
    if (!viewLast) viewLast = ts;
    const dt = Math.min(33, ts - viewLast);
    viewLast = ts;

    if (!viewPage.classList.contains("active")){
      requestAnimationFrame(viewLoop);
      return;
    }

    const W = viewCanvas.width, H = viewCanvas.height;

    // Dcop-like sky gradient
    const g = vctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, "#7fd6ff");
    g.addColorStop(0.55, "#dff6ff");
    g.addColorStop(1, "#7ddf9c");
    vctx.fillStyle = g;
    vctx.fillRect(0,0,W,H);

    // Sun
    vctx.fillStyle = "#ffd35a";
    vctx.beginPath();
    vctx.arc(W-70, 70, 36, 0, Math.PI*2);
    vctx.fill();

    // Clouds
    for (const cl of view.clouds){
      cl.x += cl.sp * dt * 4;
      if (cl.x > W + 140) cl.x = -160;
      drawCloud(vctx, cl.x, cl.y, cl.s);
    }

    // Petals (like dcop vibe)
    for (const p of view.petals){
      p.y += p.sp * dt * 6;
      p.x += p.drift * dt * 6;
      if (p.y > H + 20){ p.y = -20; p.x = rand(0,W); }
      vctx.fillStyle = `rgba(255, 160, 180, ${p.a})`;
      vctx.beginPath();
      vctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      vctx.fill();
    }

    // Grass
    vctx.fillStyle = "#43c36a";
    vctx.fillRect(0, H-140, W, 140);

    // Horizon line
    vctx.fillStyle = "rgba(0,0,0,0.08)";
    vctx.fillRect(0, H-140, W, 4);

    // Sitting avatar looking at view
    drawSittingAvatar(vctx, 140, H-170);

    requestAnimationFrame(viewLoop);
  }

  // ===== INIT =====
  resetGame();
  requestAnimationFrame(loop);
  requestAnimationFrame(viewLoop);

})();
</script>
</body>
</html>
