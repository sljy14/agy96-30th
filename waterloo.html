<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Waterloo Ballet Studio</title>
  <style>
    :root{
      --cardBg1: rgba(34, 8, 60, 0.78);
      --cardBg2: rgba(10, 7, 22, 0.72);
      --border: rgba(255,255,255,0.12);
      --text: #f3f0ff;
      --muted: rgba(243,240,255,0.78);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1100px 620px at 50% 10%, rgba(210,170,255,0.18), transparent 55%),
        radial-gradient(900px 520px at 50% 80%, rgba(140,255,220,0.10), transparent 62%),
        linear-gradient(160deg,#0a1632,#090615);
      color: var(--text);
    }
    .wrap{
      min-height:100svh;
      display:flex;
      justify-content:center;
      padding: 10px 12px 14px;
    }
    .card{
      width:min(560px, 100%);
      border-radius: 24px;
      background: linear-gradient(180deg, var(--cardBg1), var(--cardBg2));
      border: 1px solid var(--border);
      box-shadow: 0 30px 80px rgba(0,0,0,0.55);
      overflow:hidden;
    }
    .header{ padding: 16px 16px 10px; text-align:center; }
    h1{
      margin: 0 0 6px;
      font-size: 34px;
      line-height: 1.05;
      font-weight: 1000;
      letter-spacing: -0.02em;
      text-shadow: 0 2px 10px rgba(0,0,0,0.35);
    }
    .sub{ margin: 0; color: var(--muted); font-size: 13px; line-height: 1.35; }

    .hud{
      display:flex;
      gap: 10px;
      justify-content: space-between;
      padding: 0 14px 10px;
      flex-wrap: wrap;
    }
    .pill{
      flex:1;
      min-width: 160px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border-radius: 999px;
      padding: 10px 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 900;
      letter-spacing: 0.2px;
    }
    .pill small{ color: var(--muted); font-weight: 800; }

    .stage{ padding: 8px 12px 12px; }
    .frame{
      position: relative;
      border-radius: 20px;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 10px;
      overflow: hidden;
    }
    canvas{
      width:100%;
      height:auto;
      display:block;
      border-radius: 16px;
      background: #f3eaff;
      touch-action: manipulation;
    }

    /* control centre (below her) */
    .controls{
      position:absolute;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      display:flex;
      gap: 14px;
      z-index: 5;
    }
    .btn{
      width: 76px;
      height: 76px;
      border-radius: 18px;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.50);
      box-shadow: 0 10px 26px rgba(0,0,0,0.16);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 38px;
      font-weight: 900;
      color: rgba(0,0,0,0.72);
      user-select:none;
      cursor:pointer;
      backdrop-filter: blur(6px);
    }
    .btn:active{ transform: translateY(1px) scale(0.98); }

    .btnRowHint{
      padding: 0 16px 14px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    /* win overlay */
    .overlay{
      position:absolute;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 10;
      pointer-events:auto;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(420px, 92%);
      border-radius: 22px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.28);
      box-shadow: 0 30px 80px rgba(0,0,0,0.45);
      padding: 18px 16px 16px;
      text-align:center;
      backdrop-filter: blur(8px);
    }
    .modal h2{
      margin: 0 0 8px;
      font-size: 20px;
      font-weight: 1000;
      letter-spacing: -0.01em;
    }
    .modal p{
      margin: 0 0 14px;
      color: rgba(255,255,255,0.82);
      font-size: 13px;
      line-height: 1.35;
    }
    .modal button{
      width: 100%;
      border: 0;
      border-radius: 999px;
      padding: 14px 16px;
      font-weight: 1000;
      letter-spacing: 0.2px;
      background: linear-gradient(180deg, rgba(255,190,230,0.30), rgba(255,190,230,0.14));
      color: var(--text);
      border: 1px solid rgba(255,190,230,0.34);
      cursor:pointer;
    }
    .modal button:active{ transform: translateY(1px); }

    @media (max-width: 360px){
      h1{ font-size: 30px; }
      .btn{ width: 70px; height: 70px; font-size: 34px; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <h1>Welcome to the Waterloo ballet studio! ü©∞</h1>
      <p class="sub">Tap ‚Üê, ‚Üë, or ‚Üí to balance your piqu√© pose.</p>
    </div>

    <div class="hud">
      <div class="pill"><span>üéØ</span><span>Hits:&nbsp;<strong id="hits">0</strong>&nbsp;<small>/ 10</small></span></div>
      <div class="pill"><span>‚è≥</span><span>Time:&nbsp;<strong id="timer">1.6</strong><small>s</small></span></div>
      <div class="pill"><span>üôà</span><span>Falls:&nbsp;<strong id="falls">0</strong></span></div>
    </div>

    <div class="stage">
      <div class="frame">
        <canvas id="c" width="390" height="520"></canvas>

        <div class="controls">
          <div class="btn" id="leftBtn">‚Äπ</div>
          <div class="btn" id="upBtn">ÀÑ</div>
          <div class="btn" id="rightBtn">‚Ä∫</div>
        </div>

        <div class="overlay" id="overlay">
          <div class="modal">
            <h2>Congratulations! You balanced with grace under pressure. üôÜ‚Äç‚ôÄÔ∏è</h2>
            <p>Ready for the next mission?</p>
            <button id="nextBtn">On to my next adventure!</button>
          </div>
        </div>
      </div>
    </div>

    <div class="btnRowHint">10 correct cues. Each cue must be tapped within 1.6 seconds. Wrong or late = drop + instant restart.</div>
  </div>
</div>

<audio id="bgm" src="./arcade.mp3" preload="auto" loop></audio>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = true;

  const hitsEl = document.getElementById("hits");
  const timerEl = document.getElementById("timer");
  const fallsEl = document.getElementById("falls");
  const overlay = document.getElementById("overlay");
  const nextBtn = document.getElementById("nextBtn");

  const leftBtn  = document.getElementById("leftBtn");
  const rightBtn = document.getElementById("rightBtn");
  const upBtn    = document.getElementById("upBtn");

  const bgm = document.getElementById("bgm");
  let bgmStarted = false;
  async function ensureBgm(){
    if (bgmStarted) return;
    bgmStarted = true;
    try{
      bgm.volume = 0.7;
      await bgm.play();
      localStorage.setItem("bgmPlaying","true");
    }catch(e){ bgmStarted = false; }
  }
  if (localStorage.getItem("bgmPlaying")==="true") ensureBgm();

  const GOAL = 10;
  const WINDOW_MS = 1600;
  const BETWEEN_MS = 160;

  const rand = (a,b)=>a + Math.random()*(b-a);

  const game = {
    state: "playing",  // playing | falling | winAnim | winModal
    hits: 0,
    falls: 0,
    cue: null,
    tilt: 0,
    tiltTarget: 0,
    jumpT: -1,
    fallT: -1,
    confetti: [],
    confettiT: 0,
    winT: 0
  };

  // IMPORTANT: place her ABOVE the buttons (you asked)
  const dancer = {
    x: canvas.width/2,
    y: canvas.height - 210, // higher so she's clearly above the control centre
    scale: 1.0
  };

  function setHUD(){
    hitsEl.textContent = String(game.hits);
    fallsEl.textContent = String(game.falls);

    if (game.cue && game.state === "playing"){
      const remain = Math.max(0, (game.cue.deadline - performance.now())/1000);
      timerEl.textContent = remain.toFixed(1);
    } else {
      timerEl.textContent = (WINDOW_MS/1000).toFixed(1);
    }
  }

  function newCue(prevId=0){
    const now = performance.now();
    const dirs = ["left","right","up"];
    const dir = dirs[Math.floor(Math.random()*dirs.length)];
    const id = prevId + 1;

    game.cue = { dir, shownAt: now, deadline: now + WINDOW_MS, id };

    // she tilts OPPOSITE the cue
    if (dir === "left")  game.tiltTarget = +0.38; // cue left => she tips right
    if (dir === "right") game.tiltTarget = -0.38; // cue right => she tips left
    if (dir === "up")    game.tiltTarget = (Math.random()>0.5 ? 0.10 : -0.10);
  }

  function resetRound(){
    overlay.classList.remove("show");
    game.state = "playing";
    game.hits = 0;
    game.tilt = 0;
    game.tiltTarget = 0;
    game.jumpT = -1;
    game.fallT = -1;
    game.confetti = [];
    game.confettiT = 0;
    game.winT = 0;
    setHUD();
    newCue(0);
  }

  function failDrop(){
    game.falls++;
    setHUD();
    game.state = "falling";
    game.fallT = 0;
  }

  function handlePick(pick){
    ensureBgm();
    if (game.state !== "playing" || !game.cue) return;

    const now = performance.now();
    const correct = (pick === game.cue.dir);
    const late = (now > game.cue.deadline);

    if (!correct || late){
      failDrop();
      return;
    }

    // success
    game.hits++;
    setHUD();

    // straighten immediately
    game.tiltTarget = 0;

    // jump for UP
    if (pick === "up") game.jumpT = 0;

    if (game.hits >= GOAL){
      winSequence();
      return;
    }

    // force cue to "re-appear" even if same direction repeats
    const prevId = game.cue.id;
    game.cue = null;

    setTimeout(() => {
      if (game.state === "playing") newCue(prevId);
    }, BETWEEN_MS);
  }

  function spawnConfetti(){
    const colors = ["#ff6bb5","#7cf5d2","#ffd35a","#9d7bff","#4fd2ff","#ff8a5a","#7ef07a"];
    game.confetti = Array.from({length: 150}, () => ({
      x: rand(0, canvas.width),
      y: rand(-canvas.height, 0),
      w: rand(6, 14),
      h: rand(6, 14),
      vy: rand(180, 440),
      vx: rand(-100, 100),
      rot: rand(0, Math.PI*2),
      vr: rand(-6, 6),
      a: rand(0.72, 1),
      c: colors[Math.floor(Math.random()*colors.length)]
    }));
  }

  function winSequence(){
    game.state = "winAnim";
    game.cue = null;
    game.tilt = 0;
    game.tiltTarget = 0;
    game.winT = 0;
    game.confettiT = 0;
    spawnConfetti();
  }

  function roundRect(c,x,y,w,h,r){
    c.beginPath();
    c.moveTo(x+r,y);
    c.arcTo(x+w,y,x+w,y+h,r);
    c.arcTo(x+w,y+h,x,y+h,r);
    c.arcTo(x,y+h,x,y,r);
    c.arcTo(x,y,x+w,y,r);
    c.closePath();
  }

  // ====== AVATAR (FIXED FACE, ARMS UP ARC, BETTER LEGS) ======

  function drawGlasses(c, leftX, gy, lensW, lensH, thick, gap, armLen){
    c.fillStyle = "#000";
    // left lens
    c.fillRect(leftX, gy, lensW, thick);
    c.fillRect(leftX, gy + lensH - thick, lensW, thick);
    c.fillRect(leftX, gy, thick, lensH);
    c.fillRect(leftX + lensW - thick, gy, thick, lensH);

    const rightX = leftX + lensW + gap;
    // right lens
    c.fillRect(rightX, gy, lensW, thick);
    c.fillRect(rightX, gy + lensH - thick, lensW, thick);
    c.fillRect(rightX, gy, thick, lensH);
    c.fillRect(rightX + lensW - thick, gy, thick, lensH);

    // bridge
    c.fillRect(leftX + lensW, gy + Math.floor(lensH/2) - 1, gap, 2);

    // arms
    c.fillRect(leftX - armLen, gy + 2, armLen, 2);
    c.fillRect(rightX + lensW, gy + 2, armLen, 2);
  }

  function drawHeadFace(c){
  // Move head DOWN closer to torso by ~8px (was y=-60)
  const x = -18, y = -52;

  // hair
  c.fillStyle = "#000";
  c.fillRect(x, y, 36, 60);

  // face
  c.fillStyle = "#f1c7a6";
  c.fillRect(x + 6, y + 16, 24, 28);

  // glasses (same as before, just shifted with y)
  const gy = y + 22;
  const lensW = 11, lensH = 9;
  const thick = 2, gap = 5, armLen = 4;
  const leftX = x + 4;
  drawGlasses(c, leftX, gy, lensW, lensH, thick, gap, armLen);
}

function drawLegsBetter(c){
  // Hip anchor (under tutu)
  const hipX = 0;
  const hipY = 44; // slightly higher so legs originate under tutu better

  // ===== standing leg (left) =====
  c.fillStyle = "#f1c7a6";
  // long straight leg
  c.fillRect(hipX - 7, hipY, 14, 62);

  // pointe shoe
  c.fillStyle = "#fff";
  c.fillRect(hipX - 10, hipY + 58, 20, 9);

  // ===== bent leg (right) : thigh OUT then shin BACK IN =====
  // thigh should start near tutu (not from standing knee)
  c.fillStyle = "#f1c7a6";
  // horizontal thigh coming out from hip
  c.fillRect(hipX + 2, hipY + 10, 30, 10);

  // shin: angle back toward standing leg
  c.save();
  // knee point at end of thigh
  c.translate(hipX + 30, hipY + 18);
  c.rotate(-1.05); // stronger angle inward
  c.fillRect(0, 0, 10, 34);
  c.restore();

  // foot (white shoe) closer to standing leg
  c.fillStyle = "#fff";
  c.fillRect(hipX + 1, hipY + 46, 18, 9);
}


  function drawArmsUpArc(c){
    // Arms UP (fifth position vibe) ‚Äî two smooth arcs above shoulders
    c.strokeStyle = "#f1c7a6";
    c.lineWidth = 8;
    c.lineCap = "round";

    // left arm curve up
    c.beginPath();
    c.moveTo(-18, 10);
    c.quadraticCurveTo(-30, -18, -6, -34);
    c.stroke();

    // right arm curve up
    c.beginPath();
    c.moveTo(18, 10);
    c.quadraticCurveTo(30, -18, 6, -34);
    c.stroke();
  }

  function drawDancer(c, tiltRad, jumpOffset){
    c.save();
    c.translate(dancer.x, dancer.y + jumpOffset);
    c.scale(dancer.scale, dancer.scale);
    c.rotate(tiltRad);

    // torso
    c.fillStyle = "#9fd0ff";
    c.fillRect(-16, -10, 32, 42);

    // tutu
    c.fillStyle = "#ff7dbf";
    c.fillRect(-24, 26, 48, 16);
    c.fillStyle = "rgba(255,255,255,0.18)";
    c.fillRect(-22, 28, 44, 3);

    // ARMS UP (fix)
    drawArmsUpArc(c);

    // head/face (fix)
    drawHeadFace(c);

    // legs (fix + placed correctly)
    drawLegsBetter(c);

    c.restore();
  }

  function drawNameTag(c, text, x, y){
    c.save();
    c.textAlign = "center";
    c.font = "13px Arial";
    c.fillStyle = "rgba(255,255,255,0.92)";
    c.shadowColor = "rgba(0,0,0,0.35)";
    c.shadowBlur = 6;
    c.fillText(text, x, y);
    c.restore();
  }

  // ====== BACKGROUND ======
  function drawStudioBackground(){
    const W = canvas.width, H = canvas.height;

    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, "#f7efff");
    g.addColorStop(0.55, "#f3e6ff");
    g.addColorStop(1, "#f8d7e7");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // mirror wall
    ctx.save();
    ctx.globalAlpha = 0.92;
    ctx.fillStyle = "rgba(255,255,255,0.55)";
    roundRect(ctx, 16, 40, W-32, 250, 18);
    ctx.fill();
    ctx.restore();

    // mirror vertical lines
    ctx.strokeStyle = "rgba(155,120,170,0.24)";
    ctx.lineWidth = 2;
    for (let x=50; x<W; x+=70){
      ctx.beginPath();
      ctx.moveTo(x, 54);
      ctx.lineTo(x, 276);
      ctx.stroke();
    }

    // overhead lights
    ctx.fillStyle = "rgba(255,255,255,0.35)";
    for (let i=0;i<4;i++){
      roundRect(ctx, 34 + i*90, 58, 56, 14, 7);
      ctx.fill();
    }

    // barre stays mid-wall (not under her)
    ctx.fillStyle = "rgba(140,120,120,0.65)";
    ctx.fillRect(32, 320, W-64, 10);
    ctx.fillStyle = "rgba(120,110,110,0.55)";
    for (let i=0;i<6;i++){
      ctx.fillRect(54 + i*60, 330, 8, 70);
    }

    // floor
    const fg = ctx.createLinearGradient(0, 360, 0, H);
    fg.addColorStop(0, "#f0cfa8");
    fg.addColorStop(1, "#e7b47e");
    ctx.fillStyle = fg;
    ctx.fillRect(0, 360, W, H-360);

    // floor planks
    ctx.strokeStyle = "rgba(140,90,70,0.18)";
    ctx.lineWidth = 2;
    for (let x=20; x<W; x+=28){
      ctx.beginPath();
      ctx.moveTo(x, 365);
      ctx.lineTo(x, H);
      ctx.stroke();
    }

    // spotlight
    ctx.save();
    ctx.globalAlpha = 0.26;
    const spot = ctx.createRadialGradient(W/2, 395, 20, W/2, 395, 260);
    spot.addColorStop(0, "rgba(255,255,255,0.95)");
    spot.addColorStop(1, "rgba(255,255,255,0.00)");
    ctx.fillStyle = spot;
    ctx.fillRect(0,0,W,H);
    ctx.restore();

    // diagonal beam
    ctx.save();
    ctx.globalAlpha = 0.18;
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.beginPath();
    ctx.moveTo(W*0.64, 60);
    ctx.lineTo(W*0.92, 60);
    ctx.lineTo(W*0.74, H);
    ctx.lineTo(W*0.46, H);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function drawShadow(){
    ctx.save();
    ctx.globalAlpha = 0.20;
    ctx.fillStyle = "#000";
    ctx.beginPath();
    ctx.ellipse(dancer.x, dancer.y + 108, 70, 18, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function drawCueBubble(){
    if (!game.cue || game.state !== "playing") return;

    const now = performance.now();
    const t = Math.min(1, (now - game.cue.shownAt)/140);
    const pop = 0.92 + 0.08*Math.sin(Math.PI*t);

    // bubble ABOVE head
    const bx = dancer.x;
    const by = dancer.y - 170;

    ctx.save();
    ctx.translate(bx, by);
    ctx.scale(pop, pop);

    ctx.fillStyle = "rgba(255,255,255,0.86)";
    ctx.strokeStyle = "rgba(255,120,190,0.55)";
    ctx.lineWidth = 3;
    roundRect(ctx, -48, -34, 96, 68, 18);
    ctx.fill();
    ctx.stroke();

    ctx.font = "34px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji, system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    let emoji = "üëâ";
    if (game.cue.dir === "left") emoji = "üëà";
    if (game.cue.dir === "right") emoji = "üëâ";
    if (game.cue.dir === "up") emoji = "üëÜ";

    ctx.fillText(emoji, 0, 3);
    ctx.restore();
  }

  function drawConfetti(dt){
    if (!game.confetti.length) return;
    const H = canvas.height;

    for (const p of game.confetti){
      p.x += p.vx * (dt/1000);
      p.y += p.vy * (dt/1000);
      p.rot += p.vr * (dt/1000);

      if (p.y > H + 30) p.y = -30;
      if (p.x < -30) p.x = canvas.width + 30;
      if (p.x > canvas.width + 30) p.x = -30;
    }

    ctx.save();
    for (const p of game.confetti){
      ctx.globalAlpha = p.a;
      ctx.fillStyle = p.c;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.setTransform(1,0,0,1,0,0);
    }
    ctx.restore();
  }

  let last = 0;

  function update(dt){
    const now = performance.now();

    // smooth tilt
    game.tilt += (game.tiltTarget - game.tilt) * 0.12;

    // jump anim
    if (game.jumpT >= 0){
      game.jumpT += dt/260;
      if (game.jumpT >= 1) game.jumpT = -1;
    }

    // timeout fail
    if (game.state === "playing" && game.cue){
      if (now > game.cue.deadline) failDrop();
    }

    // falling anim then instant restart
    if (game.state === "falling"){
      game.fallT += dt;
      if (game.fallT > 520){
        game.state = "playing";
        game.tilt = 0;
        game.tiltTarget = 0;
        game.jumpT = -1;
        game.fallT = -1;
        game.hits = 0;
        setHUD();
        newCue(0);
      }
    }

    // win anim: scene stays, 3 jumps, confetti >=2s, then modal
    if (game.state === "winAnim"){
      game.winT += dt;
      game.confettiT += dt;

      if (game.confettiT >= 2000){
        game.state = "winModal";
        overlay.classList.add("show");
      }
    }

    setHUD();
  }

  function draw(dt){
    drawStudioBackground();
    drawShadow();

    let tilt = game.tilt;
    let extraY = 0;

    if (game.state === "falling"){
      const t = Math.min(1, game.fallT / 520);
      extraY = 220 * t * t;       // drop straight down
      tilt = tilt * (1 - t);
    }

    if (game.state === "winAnim" || game.state === "winModal"){
      tilt = 0;
    }

    // jump offsets
    let jumpOffset = 0;
    if (game.jumpT >= 0){
      const s = Math.sin(Math.PI * game.jumpT);
      jumpOffset = -18 * s;
    }
    if (game.state === "winAnim"){
      // 3 jumps across ~900ms
      const t = Math.min(900, game.winT);
      const s = Math.abs(Math.sin((Math.PI * 3) * (t/900)));
      jumpOffset = -22 * s;
    }

    ctx.save();
    ctx.translate(0, extraY);
    drawDancer(ctx, tilt, jumpOffset);
    ctx.restore();

    // agy96 label ABOVE her head (not near buttons)
    drawNameTag(ctx, "agy96", dancer.x, dancer.y - 95);

    drawCueBubble();

    if (game.state === "winAnim" || game.state === "winModal"){
      drawConfetti(dt);
    }
  }

  function loop(ts){
    if (!last) last = ts;
    const dt = Math.min(33, ts - last);
    last = ts;
    update(dt);
    draw(dt);
    requestAnimationFrame(loop);
  }

  function bindBtn(el, dir){
    el.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      handlePick(dir);
    }, {passive:false});
  }

  bindBtn(leftBtn, "left");
  bindBtn(rightBtn, "right");
  bindBtn(upBtn, "up");

  nextBtn.addEventListener("click", ()=>{
    ensureBgm();
    localStorage.setItem("mapPromptIndex", "3"); // stadium prompt
    location.href = "./map.html";
  });

  // start
  resetRound();
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
