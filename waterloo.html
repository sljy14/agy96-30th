<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Waterloo ‚Äî Ballet Balance</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
<div id="wrap">
  <div class="bg"></div>
  <canvas id="c"></canvas>

  <div class="hud">
    <div>
      <div class="title">Waterloo ü©∞</div>
      <div class="sub">Balance the pirouette ‚Äî keep it centered ‚ú®</div>
    </div>
    <div class="right">
      <div>Hold: <span id="hold">0.0</span>s / 5.0s</div>
      <div>Strikes: <span id="strikes">0</span> / 3</div>
    </div>
  </div>

  <div class="centerOverlay" id="overlay">
    <div class="card">
      <div class="big" id="big">Grace under pressure ü©∞</div>
      <div class="small" id="small">Tap LEFT or RIGHT to steady her. Stay centered for 5 seconds.</div>
      <div class="hint">Tap to start</div>
    </div>
  </div>

  <div class="zone" id="leftZone"></div>
  <div class="zone" id="rightZone"></div>
</div>

<script type="module">
  import { fitCanvas, rand, clamp, tapPrevent, setDone } from "./js/app.js";

  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  window.addEventListener("resize", ()=>fitCanvas(canvas,ctx));
  fitCanvas(canvas,ctx);

  const overlay = document.getElementById("overlay");
  const big = document.getElementById("big");
  const small = document.getElementById("small");
  const holdEl = document.getElementById("hold");
  const strikesEl = document.getElementById("strikes");
  const leftZone = document.getElementById("leftZone");
  const rightZone = document.getElementById("rightZone");

  const GOAL = 5.0;
  const MAX_STRIKES = 3;

  let running=false, won=false;
  let balance=0;      // -1..+1
  let vel=0;
  let hold=0;
  let strikes=0;

  function hud(){
    holdEl.textContent = hold.toFixed(1);
    strikesEl.textContent = strikes;
  }

  function show(t, msg, hint="Tap to continue"){
    big.textContent=t;
    small.innerHTML=msg;
    overlay.querySelector(".hint").textContent = hint;
    overlay.style.display="flex";
  }
  function hide(){ overlay.style.display="none"; }

  function reset(){
    running=true; won=false;
    balance=0; vel=0; hold=0; strikes=0;
    hide(); hud();
  }

  function strike(){
    strikes++; hud();
    running=false;
    show("Try again! üòó", "Steady‚Ä¶ steady‚Ä¶<br/>You‚Äôve got this ‚ú®", "Tap to continue");
    balance=0; vel=0;
    if (strikes>=MAX_STRIKES){
      strikes=0; hold=0; hud();
      show("Reset ü©∞", "Ballet is repetition.<br/>One more clean run.", "Tap to restart");
    }
  }

  function win(){
    running=false; won=true;
    setDone("waterloo", true);
    show("Encore? You nailed it ‚ú®", "Quiet strength. Pure focus.<br/><b>Back to the map?</b>", "Tap to go back");
  }

  // tap controls:
  const tapImpulse = 0.09;
  function tap(side){
    if (overlay.style.display!=="none"){
      if (won) location.href="./map.html";
      else reset();
      return;
    }
    if (!running) return;
    if (side==="left") vel += tapImpulse;
    else vel -= tapImpulse;
  }

  tapPrevent(leftZone, ()=>tap("left"));
  tapPrevent(rightZone, ()=>tap("right"));
  overlay.addEventListener("click", ()=>{ if (won) location.href="./map.html"; else reset(); });

  let last=0;
  function loop(ts){
    requestAnimationFrame(loop);
    const dt = Math.min(32, ts-last||16); last=ts;

    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

    // simple studio floor + mirror vibe
    ctx.globalAlpha=0.10; ctx.fillStyle="#fff";
    ctx.fillRect(0, window.innerHeight*0.72, window.innerWidth, window.innerHeight*0.28);
    ctx.fillRect(window.innerWidth*0.18, window.innerHeight*0.20, window.innerWidth*0.64, window.innerHeight*0.36);
    ctx.globalAlpha=1;

    // physics
    if (running){
      vel += rand(-0.015, 0.015) * (dt/16);
      vel *= 0.985;
      balance += vel * (dt/16);
      balance = clamp(balance, -1.2, 1.2);

      if (Math.abs(balance) < 0.14) hold += dt/1000;
      else hold = Math.max(0, hold - dt/1200);

      hud();
      if (Math.abs(balance) > 1.05) strike();
      if (hold >= GOAL) win();
    }

    // draw ballerina (emoji placeholder now; swap to PNG later)
    const cx = window.innerWidth/2 + balance*140;
    const cy = window.innerHeight*0.62;

    ctx.font="44px system-ui";
    ctx.textAlign="center";
    ctx.fillText("ü©∞", cx, cy-60);
    ctx.font="34px system-ui";
    ctx.fillText("üßç‚Äç‚ôÄÔ∏è", cx, cy);

    // balance meter
    const mx = window.innerWidth/2, my = window.innerHeight*0.86, mw = Math.min(320, window.innerWidth*0.78);
    ctx.globalAlpha=0.9;
    ctx.fillStyle="rgba(255,255,255,0.12)";
    ctx.fillRect(mx-mw/2, my, mw, 10);
    ctx.fillStyle="rgba(255,255,255,0.95)";
    ctx.fillRect(mx-2 + balance*(mw/2-10), my-6, 4, 22);

    // center window marker
    ctx.globalAlpha=0.25;
    ctx.fillRect(mx-10, my-10, 20, 30);
    ctx.globalAlpha=1;
  }
  requestAnimationFrame(loop);
</script>
</body>
</html>
