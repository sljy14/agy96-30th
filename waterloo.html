<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Waterloo Ballet Studio</title>
  <style>
    :root{
      --cardBg1: rgba(38, 14, 62, 0.84);
      --cardBg2: rgba(18, 9, 34, 0.84);
      --stroke: rgba(255,255,255,0.14);
      --text: #f5f2ff;
      --muted: rgba(245,242,255,0.78);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background:
        radial-gradient(900px 540px at 50% 16%, rgba(255,140,230,0.14), transparent 60%),
        radial-gradient(900px 540px at 50% 86%, rgba(140,255,220,0.10), transparent 62%),
        linear-gradient(160deg,#0b0b18,#0a0620);
    }

    .wrap{
      min-height:100svh;
      display:flex;
      justify-content:center;
      padding: 10px 12px 14px;
    }

    .card{
      width:min(560px, 100%);
      border-radius: 24px;
      background: linear-gradient(180deg, var(--cardBg1), var(--cardBg2));
      border: 1px solid var(--stroke);
      box-shadow: 0 30px 80px rgba(0,0,0,0.55);
      overflow:hidden;
    }

    .header{
      padding: 16px 16px 10px;
      text-align:center;
    }
    h1{
      margin: 0 0 6px;
      font-size: 34px;
      line-height: 1.08;
      font-weight: 950;
      letter-spacing: -0.02em;
      text-shadow: 0 2px 10px rgba(0,0,0,0.35);
    }
    .sub{
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }

    .hud{
      display:flex;
      gap: 10px;
      justify-content: space-between;
      padding: 0 14px 10px;
    }
    .pill{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border-radius: 999px;
      padding: 10px 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 900;
      letter-spacing: 0.2px;
      min-width: 0;
    }
    .pill small{
      color: var(--muted);
      font-weight: 800;
    }

    .stage{ padding: 8px 12px 12px; }
    .frame{
      border-radius: 20px;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 10px;
      position: relative;
    }

    canvas{
      width:100%;
      height:auto;
      display:block;
      border-radius: 16px;
      background: #f4e9ff;
      touch-action: manipulation;
    }

    /* overlay: cue bubble */
    .cueBubble{
      position:absolute;
      left:50%;
      top: 18%;
      transform: translate(-50%, -50%);
      padding: 14px 18px;
      border-radius: 18px;
      background: rgba(255,255,255,0.80);
      border: 2px solid rgba(255,140,210,0.50);
      box-shadow: 0 10px 26px rgba(0,0,0,0.18);
      font-size: 28px;
      line-height: 1;
      user-select:none;
      pointer-events:none;
      opacity: 0;
    }

    @keyframes cuePop{
      0%{ transform: translate(-50%,-50%) scale(0.92); opacity: 0; }
      18%{ transform: translate(-50%,-50%) scale(1.02); opacity: 1; }
      70%{ transform: translate(-50%,-50%) scale(1.00); opacity: 1; }
      100%{ transform: translate(-50%,-50%) scale(0.98); opacity: 0.20; }
    }
    .cueBubble.show{
      animation: cuePop 680ms ease-out 1;
      opacity: 1;
    }

    /* control centre */
    .controls{
      position:absolute;
      left:50%;
      bottom: 18px; /* on the floor */
      transform: translateX(-50%);
      display:flex;
      gap: 16px;
      align-items:center;
      justify-content:center;
      z-index: 5;
    }
    .ctrlBtn{
      width: 86px;
      height: 86px;
      border-radius: 18px;
      background: rgba(255,255,255,0.42);
      border: 1px solid rgba(255,255,255,0.45);
      box-shadow: 0 14px 28px rgba(0,0,0,0.16);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 42px;
      font-weight: 900;
      color: rgba(30,30,40,0.78);
      user-select:none;
      cursor:pointer;
      backdrop-filter: blur(6px);
    }
    .ctrlBtn:active{ transform: translateY(1px) scale(0.99); }

    /* win modal */
    .modal{
      position:absolute;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,0.32);
      z-index: 20;
    }
    .modal.show{ display:flex; }
    .box{
      width: min(420px, 92%);
      border-radius: 22px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.28);
      padding: 16px 16px 14px;
      text-align:center;
    }
    .box h2{
      margin: 6px 0 8px;
      font-size: 18px;
      letter-spacing: -0.01em;
      font-weight: 950;
    }
    .box p{
      margin: 0 0 12px;
      color: rgba(255,255,255,0.85);
      font-size: 13px;
      line-height: 1.35;
    }
    .btn{
      appearance:none;
      border: 0;
      border-radius: 999px;
      padding: 14px 16px;
      font-weight: 950;
      letter-spacing: 0.2px;
      background: linear-gradient(180deg, rgba(255,210,235,0.30), rgba(255,210,235,0.16));
      color: var(--text);
      border: 1px solid rgba(255,210,235,0.30);
      cursor:pointer;
      width: 100%;
      max-width: 360px;
    }
    .btn:active{ transform: translateY(1px); }

    /* confetti canvas overlay */
    #confetti{
      position:absolute;
      inset: 10px;
      width: calc(100% - 20px);
      height: calc(100% - 20px);
      border-radius: 16px;
      pointer-events:none;
      z-index: 10;
      display:none;
    }
    #confetti.show{ display:block; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="header">
      <h1>Welcome to the Waterloo ballet studio! ü©∞</h1>
      <p class="sub">Tap left, up, or right to balance your piqu√© pose.</p>
    </div>

    <div class="hud">
      <div class="pill"><span>üéØ</span><span>Hits:&nbsp;<strong id="hits">0</strong>&nbsp;<small>/ 10</small></span></div>
      <div class="pill"><span>‚è≥</span><span>Time:&nbsp;<strong id="time">1.6</strong><small>s</small></span></div>
    </div>

    <div class="stage">
      <div class="frame">
        <canvas id="game" width="390" height="520" aria-label="Waterloo ballet game"></canvas>

        <!-- cue bubble -->
        <div id="cueBubble" class="cueBubble">üëâ</div>

        <!-- confetti overlay -->
        <canvas id="confetti"></canvas>

        <!-- controls on studio floor -->
        <div class="controls" aria-label="Controls">
          <div class="ctrlBtn" id="btnLeft"  role="button" aria-label="Left">‚Äπ</div>
          <div class="ctrlBtn" id="btnUp"    role="button" aria-label="Up">‚åÉ</div>
          <div class="ctrlBtn" id="btnRight" role="button" aria-label="Right">‚Ä∫</div>
        </div>

        <!-- win modal -->
        <div id="modal" class="modal" role="dialog" aria-modal="true">
          <div class="box">
            <h2>Congratulations! You balanced with grace under pressure. üôÜ‚Äç‚ôÄÔ∏è</h2>
            <p id="modalHint">Ready for the next mission?</p>
            <button id="nextBtn" class="btn">On to my next mission!</button>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<audio id="bgm" src="./arcade.mp3" loop preload="auto"></audio>

<script>
(() => {
  // ===== BGM =====
  const bgm = document.getElementById("bgm");
  bgm.volume = 0.55;

  function tryPlayBgm(){
    bgm.play()
      .then(()=>localStorage.setItem("bgmPlaying","true"))
      .catch(()=>{});
  }
  if (localStorage.getItem("bgmPlaying")==="true") tryPlayBgm();

  // ===== DOM =====
  const hitsEl = document.getElementById("hits");
  const timeEl = document.getElementById("time");
  const cueBubble = document.getElementById("cueBubble");
  const modal = document.getElementById("modal");
  const nextBtn = document.getElementById("nextBtn");

  const btnLeft = document.getElementById("btnLeft");
  const btnUp = document.getElementById("btnUp");
  const btnRight = document.getElementById("btnRight");

  // ===== CANVAS =====
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = true;

  const conf = document.getElementById("confetti");
  const cfx = conf.getContext("2d");
  cfx.imageSmoothingEnabled = true;

  function syncConfettiSize(){
    const rect = canvas.getBoundingClientRect();
    conf.width = Math.max(1, Math.floor(rect.width * devicePixelRatio));
    conf.height = Math.max(1, Math.floor(rect.height * devicePixelRatio));
    conf.style.width = rect.width + "px";
    conf.style.height = rect.height + "px";
    cfx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", syncConfettiSize);

  // ===== GAME SETTINGS =====
  const GOAL = 10;
  const CUE_TIME = 1.6; // seconds
  const FALL_SPEED = 18; // px/frame feel (visual)
  const TILT_MAX = 24;   // degrees-ish (we'll use radians)
  const CENTER_RETURN_SPEED = 0.22;

  // cue types:
  // "L" means cue üëà (tap LEFT), avatar tilts RIGHT
  // "R" means cue üëâ (tap RIGHT), avatar tilts LEFT
  // "U" means cue üëÜ (tap UP), avatar does jump
  const cueEmoji = { L:"üëà", R:"üëâ", U:"üëÜ" };

  const state = {
    running: true,
    hits: 0,
    remaining: CUE_TIME,
    cue: "R",
    // visual
    tilt: 0,         // current tilt (radians)
    tiltTarget: 0,
    y: 0,            // avatar baseline y (feet)
    y0: 0,
    jumpV: 0,
    mode: "playing", // playing | falling | win
    fallY: 0,
    fallV: 0,
    // win celebration
    winStart: 0,
    showButtonAt: 0
  };

  // layout positions inside canvas
  const P = {
    W: canvas.width,
    H: canvas.height,
    // you asked: move avatar to old button height (higher),
    // and move buttons down to floor (we did in DOM).
    avatarX: canvas.width/2,
    avatarY: 310, // higher (matches your request)
    floorY: 418
  };

  // ===== UI =====
  function setHUD(){
    hitsEl.textContent = String(state.hits);
    timeEl.textContent = state.remaining.toFixed(1);
  }

  function showCue(){
    // force re-trigger even if same cue repeats
    cueBubble.classList.remove("show");
    void cueBubble.offsetWidth;
    cueBubble.textContent = cueEmoji[state.cue];
    cueBubble.classList.add("show");
    cueBubble.style.opacity = "1";
  }

  function pickNextCue(prevCue){
    // avoid too many same in a row? We'll allow repeats, but fair distribution
    // weights: L/R more common than U
    const bag = ["L","R","L","R","U"]; // 40/40/20
    const next = bag[Math.floor(Math.random()*bag.length)];
    return next;
  }

  function setTiltForCue(cue){
    // tilt OPPOSITE of what user must press (as requested)
    // cue R => tap RIGHT => she tilts LEFT (negative)
    // cue L => tap LEFT  => she tilts RIGHT (positive)
    // cue U => jump (no tilt)
    if (cue === "R") state.tiltTarget = -TILT_MAX * Math.PI/180;
    else if (cue === "L") state.tiltTarget =  TILT_MAX * Math.PI/180;
    else state.tiltTarget = 0;
  }

  function resetRound(){
    state.running = true;
    state.hits = 0;
    state.remaining = CUE_TIME;
    state.cue = pickNextCue(null);
    state.tilt = 0;
    state.tiltTarget = 0;
    state.mode = "playing";
    state.fallY = 0;
    state.fallV = 0;
    state.jumpV = 0;
    state.y0 = P.avatarY;
    state.y = P.avatarY;
    modal.classList.remove("show");
    conf.classList.remove("show");
    setTiltForCue(state.cue);
    showCue();
    setHUD();
  }

  function startNextCue(){
    state.remaining = CUE_TIME;
    state.cue = pickNextCue(state.cue);
    setTiltForCue(state.cue);
    showCue();
    setHUD();
  }

  function failNow(){
    // obvious fall straight down + instant restart
    state.mode = "falling";
    state.fallY = 0;
    state.fallV = 0;
  }

  function winNow(){
    state.mode = "win";
    state.running = false;

    // 3 jumps over ~1.2s + confetti for >=2s, THEN show button popup
    const now = performance.now();
    state.winStart = now;
    state.showButtonAt = now + 2200; // confetti at least 2s

    // start confetti immediately
    syncConfettiSize();
    conf.classList.add("show");
    spawnConfetti(220); // chaotic
  }

  // ===== INPUT =====
  function handlePress(which){
    tryPlayBgm();

    if (state.mode !== "playing") return;

    const needed = state.cue; // L/R/U
    const ok = (which === needed);

    if (!ok){
      failNow();
      return;
    }

    // correct hit
    state.hits++;
    hitsEl.textContent = String(state.hits);

    // return to centre immediately
    state.tiltTarget = 0;

    // if cue was UP, do a quick jump
    if (needed === "U"){
      state.jumpV = -10.5; // small hop
    }

    if (state.hits >= GOAL){
      winNow();
      return;
    }

    // small delay so cue feels like it "re-appears"
    setTimeout(() => {
      if (state.mode === "playing") startNextCue();
    }, 120);
  }

  btnLeft.addEventListener("pointerdown", (e)=>{ e.preventDefault(); handlePress("L"); }, {passive:false});
  btnRight.addEventListener("pointerdown",(e)=>{ e.preventDefault(); handlePress("R"); }, {passive:false});
  btnUp.addEventListener("pointerdown",   (e)=>{ e.preventDefault(); handlePress("U"); }, {passive:false});

  // keyboard (optional)
  window.addEventListener("keydown",(e)=>{
    if (e.key === "ArrowLeft") handlePress("L");
    if (e.key === "ArrowRight") handlePress("R");
    if (e.key === "ArrowUp") handlePress("U");
  });

  // ===== DRAW: background =====
  function drawStudio(){
    const W = canvas.width, H = canvas.height;

    // soft wall gradient
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, "#f5dcf0");
    g.addColorStop(0.55, "#f3e9fb");
    g.addColorStop(1, "#f2cfa6");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // mirror wall panels
    ctx.save();
    ctx.globalAlpha = 0.36;
    ctx.fillStyle = "#ffffff";
    for (let i=0;i<6;i++){
      const x = 28 + i*60;
      ctx.fillRect(x, 78, 32, 10); // top highlight blocks
    }
    ctx.restore();

    // mirror vertical seams
    ctx.save();
    ctx.globalAlpha = 0.18;
    ctx.strokeStyle = "#6b5c7a";
    ctx.lineWidth = 2;
    for (let i=0;i<6;i++){
      const x = 48 + i*60;
      ctx.beginPath();
      ctx.moveTo(x, 92);
      ctx.lineTo(x, 350);
      ctx.stroke();
    }
    ctx.restore();

    // baseboard
    ctx.fillStyle = "rgba(150, 90, 150, 0.18)";
    ctx.fillRect(0, 350, W, 8);

    // ballet barre
    ctx.save();
    ctx.globalAlpha = 0.62;
    ctx.fillStyle = "#7b5a4d";
    ctx.fillRect(0, 310, W, 10);
    ctx.fillStyle = "#6c5c72";
    for (let i=0;i<6;i++){
      ctx.fillRect(34 + i*64, 320, 8, 46);
    }
    ctx.restore();

    // floor boards
    ctx.save();
    ctx.globalAlpha = 0.20;
    ctx.strokeStyle = "#8f6b44";
    ctx.lineWidth = 2;
    for (let x=0;x<=W;x+=28){
      ctx.beginPath();
      ctx.moveTo(x, 366);
      ctx.lineTo(x, H);
      ctx.stroke();
    }
    ctx.restore();

    // spotlight cone (subtle) + light dots up top
    ctx.save();
    ctx.globalAlpha = 0.16;
    ctx.fillStyle = "#ffffff";
    ctx.beginPath();
    ctx.moveTo(W*0.72, 0);
    ctx.lineTo(W*0.92, 0);
    ctx.lineTo(W*0.62, H);
    ctx.lineTo(W*0.40, H);
    ctx.closePath();
    ctx.fill();
    ctx.restore();

    // ceiling lights (soft rectangles)
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = "#ffffff";
    for (let i=0;i<4;i++){
      ctx.fillRect(50 + i*82, 70, 54, 10);
    }
    ctx.restore();

    // soft vignette
    const v = ctx.createRadialGradient(W/2, H/2, 50, W/2, H/2, 330);
    v.addColorStop(0, "rgba(0,0,0,0)");
    v.addColorStop(1, "rgba(0,0,0,0.14)");
    ctx.fillStyle = v;
    ctx.fillRect(0,0,W,H);
  }

  // ===== DRAW: avatar =====
  function drawGlasses(c, leftX, gy, lensW, lensH, thick, gap, armLen){
    c.fillStyle = "#000";
    c.fillRect(leftX, gy, lensW, thick);
    c.fillRect(leftX, gy + lensH - thick, lensW, thick);
    c.fillRect(leftX, gy, thick, lensH);
    c.fillRect(leftX + lensW - thick, gy, thick, lensH);

    const rightX = leftX + lensW + gap;
    c.fillRect(rightX, gy, lensW, thick);
    c.fillRect(rightX, gy + lensH - thick, lensW, thick);
    c.fillRect(rightX, gy, thick, lensH);
    c.fillRect(rightX + lensW - thick, gy, thick, lensH);

    c.fillRect(leftX + lensW, gy + Math.floor(lensH/2) - 1, gap, 2);
    c.fillRect(leftX - armLen, gy + 2, armLen, 2);
    c.fillRect(rightX + lensW, gy + 2, armLen, 2);
  }

  function drawAgyBallet(x, feetY, tiltRad){
    ctx.save();

    // rotate around hips area (so legs feel anchored)
    const hipX = x;
    const hipY = feetY - 54;

    ctx.translate(hipX, hipY);
    ctx.rotate(tiltRad);
    ctx.translate(-hipX, -hipY);

    // shadow (not rotated)
    ctx.restore();
    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,0.18)";
    ctx.beginPath();
    ctx.ellipse(x, feetY + 14, 76, 20, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    ctx.save();
    ctx.translate(hipX, hipY);
    ctx.rotate(tiltRad);
    ctx.translate(-hipX, -hipY);

    // hair
    ctx.fillStyle="#000";
    ctx.fillRect(x-18, feetY-136, 36, 60);
    // face
    ctx.fillStyle="#f1c7a6";
    ctx.fillRect(x-12, feetY-120, 24, 28);

    // glasses
    const gy = feetY - 114;
    const lensW = 11, lensH = 9, thick = 2, gap = 5, armLen = 4;
    drawGlasses(ctx, x - 14, gy, lensW, lensH, thick, gap, armLen);

    // sleeveless top (light blue)
    ctx.fillStyle="#a7d4ff";
    ctx.fillRect(x-16, feetY-92, 32, 34);

    // arms: arcs ABOVE (as requested)
    ctx.strokeStyle = "rgba(241,199,166,1)";
    ctx.lineWidth = 6;
    ctx.lineCap = "round";

    // left arm arc
    ctx.beginPath();
    ctx.arc(x-16, feetY-92, 22, Math.PI*0.10, Math.PI*0.95, false);
    ctx.stroke();

    // right arm arc
    ctx.beginPath();
    ctx.arc(x+16, feetY-92, 22, Math.PI*0.05, Math.PI*0.90, true);
    ctx.stroke();

    // tutu (pink)
    ctx.fillStyle="#ff84c2";
    ctx.fillRect(x-28, feetY-60, 56, 18);
    ctx.fillStyle="rgba(255,255,255,0.20)";
    ctx.fillRect(x-26, feetY-58, 52, 2);

    // legs (canvas arcs/segments; anchored under tutu)
    const hip = { x, y: feetY-42 };

    // standing leg (left) straight down
    ctx.strokeStyle = "rgba(241,199,166,1)";
    ctx.lineWidth = 10;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(hip.x-6, hip.y);
    ctx.lineTo(hip.x-12, feetY-2);
    ctx.stroke();

    // standing shoe
    ctx.fillStyle="#fff";
    ctx.fillRect(hip.x-22, feetY-2, 22, 8);

    // bent leg (right): thigh horizontal near tutu, shin diagonals back to standing leg
    // thigh
    ctx.lineWidth = 9;
    ctx.beginPath();
    ctx.moveTo(hip.x+4, hip.y+4);
    ctx.lineTo(hip.x+26, hip.y+4); // horizontal out
    ctx.stroke();

    // shin: angled back toward standing leg
    ctx.beginPath();
    ctx.moveTo(hip.x+26, hip.y+4);
    ctx.lineTo(hip.x+14, hip.y+26);
    ctx.stroke();

    // bent shoe
    ctx.fillStyle="#fff";
    ctx.fillRect(hip.x+6, hip.y+24, 20, 7);

    ctx.restore();
  }

  // ===== UPDATE LOOP =====
  let last = 0;
  function loop(ts){
    if (!last) last = ts;
    const dt = Math.min(33, ts - last) / 1000; // seconds
    last = ts;

    if (state.mode === "playing"){
      state.remaining -= dt;
      if (state.remaining <= 0){
        failNow();
      }

      // smooth tilt toward target
      state.tilt += (state.tiltTarget - state.tilt) * 0.10;

      // settle back to center slowly after a hit
      if (Math.abs(state.tiltTarget) < 0.0001){
        state.tilt *= (1 - CENTER_RETURN_SPEED*dt);
      }

      // jump physics (UP cue)
      if (state.jumpV !== 0 || state.y !== state.y0){
        state.y += state.jumpV;
        state.jumpV += 0.9;
        if (state.y >= state.y0){
          state.y = state.y0;
          state.jumpV = 0;
        }
      }

      setHUD();
    }

    if (state.mode === "falling"){
      // drop straight down quickly, then restart
      state.fallV += 1800 * dt;
      state.fallY += state.fallV * dt;
      if (state.fallY > 520){
        resetRound();
      }
    }

    if (state.mode === "win"){
      // keep drawing confetti + do 3 jumps
      const now = performance.now();
      const t = now - state.winStart;

      // 3 jumps via a sine pulse
      const jump = (t < 1200) ? Math.abs(Math.sin(t/1200 * Math.PI * 3)) : 0;
      state.y = state.y0 - jump * 18;

      updateConfetti(dt);

      if (now >= state.showButtonAt){
        modal.classList.add("show");
      }
    }

    draw();
    requestAnimationFrame(loop);
  }

  function draw(){
    drawStudio();

    // draw avatar (or falling)
    const x = P.avatarX;
    let feetY = state.y;

    if (state.mode === "falling"){
      // tilt freezes + drop sprite down
      feetY = P.avatarY + state.fallY;
    }

    // if falling, force a bigger tilt for drama
    const tilt = (state.mode === "falling") ? (state.tiltTarget || -0.5) : state.tilt;

    drawAgyBallet(x, feetY, tilt);

    // simple ‚Äúfloor line‚Äù
    ctx.save();
    ctx.globalAlpha = 0.20;
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 468, canvas.width, 6);
    ctx.restore();
  }

  // ===== CONFETTI =====
  let confetti = [];
  function spawnConfetti(n){
    confetti = [];
    const W = canvas.width, H = canvas.height;
    for (let i=0;i<n;i++){
      confetti.push({
        x: Math.random()*W,
        y: -20 - Math.random()*H*0.6,
        vx: (Math.random()*2 - 1) * 180,
        vy: 220 + Math.random()*520,
        s: 4 + Math.random()*6,
        r: Math.random()*Math.PI*2,
        vr: (Math.random()*2 - 1) * 8,
        a: 0.85
      });
    }
  }

  function updateConfetti(dt){
    const W = canvas.width, H = canvas.height;
    cfx.clearRect(0,0,conf.width,conf.height);

    // draw relative to canvas size (CSS pixels)
    cfx.save();
    cfx.translate(0,0);

    for (const p of confetti){
      p.vy += 380 * dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.r += p.vr * dt;

      // wrap sideways
      if (p.x < -20) p.x = W + 20;
      if (p.x > W + 20) p.x = -20;

      // recycle bottom
      if (p.y > H + 30){
        p.y = -30 - Math.random()*H*0.2;
        p.x = Math.random()*W;
        p.vy = 240 + Math.random()*520;
      }

      // draw
      cfx.save();
      cfx.globalAlpha = p.a;
      cfx.translate(p.x, p.y);
      cfx.rotate(p.r);
      cfx.fillStyle = `hsla(${Math.floor(Math.random()*360)}, 90%, 70%, 0.95)`;
      cfx.fillRect(-p.s/2, -p.s/2, p.s, p.s*1.6);
      cfx.restore();
    }

    cfx.restore();
  }

  // ===== NAV =====
  nextBtn.addEventListener("click", ()=>{
    // go back to map with stadium prompt
    localStorage.setItem("mapPromptIndex", "3");
    location.href = "./map.html";
  });

  // ===== INIT =====
  resetRound();
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
