<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Waterloo Ballet Studio</title>
  <style>
    :root{
      --cardBg1: rgba(40, 18, 64, 0.20);
      --cardBg2: rgba(20, 8, 34, 0.18);
      --border: rgba(255,255,255,0.14);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.78);
      --pink: #ff7fb6;
      --soft: #f7eaff;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background:
        radial-gradient(900px 520px at 50% 20%, rgba(255, 170, 230, 0.14), transparent 62%),
        radial-gradient(900px 520px at 50% 80%, rgba(170, 210, 255, 0.12), transparent 62%),
        linear-gradient(160deg,#2a1040,#070714);
      min-height:100svh;
    }

    .wrap{
      min-height:100svh;
      display:flex;
      justify-content:center;
      padding: 10px 12px 14px;
    }
    .card{
      width:min(560px, 100%);
      border-radius: 24px;
      background: linear-gradient(180deg, var(--cardBg1), var(--cardBg2));
      border: 1px solid var(--border);
      box-shadow: 0 30px 80px rgba(0,0,0,0.45);
      overflow:hidden;
    }

    .header{
      padding: 16px 16px 10px;
      text-align:center;
    }
    h1{
      margin: 0 0 6px;
      font-size: 32px;
      line-height: 1.08;
      font-weight: 900;
      letter-spacing: -0.02em;
      text-shadow: 0 2px 10px rgba(0,0,0,0.25);
    }
    .sub{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .hud{
      display:flex;
      gap: 10px;
      justify-content: space-between;
      padding: 0 14px 10px;
      align-items:center;
    }
    .pill{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border-radius: 999px;
      padding: 10px 10px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      font-weight: 900;
      letter-spacing: 0.2px;
      min-width: 0;
    }
    .pill small{
      color: var(--muted);
      font-weight: 700;
    }

    .stage{ padding: 8px 12px 10px; }
    .frame{
      border-radius: 20px;
      background: rgba(0,0,0,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 10px;
    }

    .arena{
      position:relative;
      width:100%;
      aspect-ratio: 1 / 1.22;
      border-radius: 16px;
      overflow:hidden;
      background:
        radial-gradient(120% 100% at 50% 40%, rgba(0,0,0,0.00) 55%, rgba(0,0,0,0.10) 100%),
        linear-gradient(180deg,#fbf7ff 0%, #f2e8ff 60%, #f1d8ff 60%, #f1d8ff 100%);
      border: 1px solid rgba(0,0,0,0.08);
    }

    /* mirror band */
    .arena::before{
      content:"";
      position:absolute;
      left:0; right:0;
      top:18%;
      height:38%;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.10)),
        linear-gradient(90deg, rgba(0,0,0,0.08), rgba(0,0,0,0.00), rgba(0,0,0,0.08));
      opacity:0.70;
      pointer-events:none;
    }

    /* mirror trim */
    .arena::after{
      content:"";
      position:absolute;
      left:0; right:0;
      top:56%;
      height:3px;
      background:rgba(140,110,170,0.25);
      pointer-events:none;
    }

    /* ballet barre */
    .barre{
      position:absolute;
      left:6%;
      right:6%;
      top:62%;
      height:12px;
      background:linear-gradient(180deg,#d7a26a,#b87942);
      border-radius:999px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
      pointer-events:none;
    }
    .barre::before{
      content:"";
      position:absolute;
      left:10%;
      top:12px;
      width:10px;height:40px;
      background:linear-gradient(180deg,#8f7b8f,#6a566a);
      border-radius:8px;
      opacity:0.9;
    }
    .barre::after{
      content:"";
      position:absolute;
      right:10%;
      top:12px;
      width:10px;height:40px;
      background:linear-gradient(180deg,#8f7b8f,#6a566a);
      border-radius:8px;
      opacity:0.9;
    }

    /* floor */
    .floor{
      position:absolute;
      bottom:0;
      width:100%;
      height:35%;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.20), rgba(0,0,0,0.02)),
        repeating-linear-gradient(
          90deg,
          rgba(255,255,255,0.06) 0 18px,
          rgba(0,0,0,0.05) 18px 20px
        ),
        linear-gradient(180deg,#f2c58a,#e1a866);
      pointer-events:none;
    }

    /* avatar */
    .avatar{
      position:absolute;
      bottom:35%;
      left:50%;
      width:110px;
      height:170px;
      transform:translateX(-50%) rotate(0deg);
      transform-origin: 50% 92%;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.18));
    }

    .hair{
      position:absolute;
      width:64px;height:96px;
      background:#000;
      left:50%;transform:translateX(-50%);
      top:0;border-radius:10px;
    }
    .face{
      position:absolute;
      width:42px;height:50px;
      background:#f1c7a6;
      left:50%;transform:translateX(-50%);
      top:26px;
    }

    .glasses{
      position:absolute;
      top:48px;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      gap:6px;
      align-items:center;
    }
    .glasses .lens{
      width:16px;height:13px;
      border:3px solid #000;
      box-sizing:border-box;
      background:transparent;
    }
    .glasses .bridge{
      width:10px;height:3px;
      background:#000;
      margin-top:-2px;
    }

    .top{
      position:absolute;
      top:92px;
      left:50%;
      transform:translateX(-50%);
      width:52px;height:30px;
      background:#8ecaff;
      border-radius:2px;
    }
    .tutu{
      position:absolute;
      top:114px;
      left:50%;
      transform:translateX(-50%);
      width:78px;height:20px;
      background:#ff9ccf;
      border-radius:2px;
    }

    /* rounded arms */
    .arm{
      position:absolute;
      top:92px;
      width:44px;
      height:44px;
      border:6px solid #f1c7a6;
      border-color:#f1c7a6 transparent transparent transparent;
      border-radius:50%;
      opacity:0.95;
    }
    .arcL{ left:6px; transform:rotate(-20deg); }
    .arcR{ right:6px; transform:rotate(20deg) scaleX(-1); }

    /* legs */
    .leg{
      position:absolute;
      width:10px;
      background:#f1c7a6;
      border-radius:4px;
    }
    .leg.support{
      height:44px;
      top:132px;
      left:52%;
      transform:translateX(-50%);
    }
    .shoe{
      position:absolute;
      width:18px;height:8px;
      background:#ffe7f2;
      border-radius:4px;
    }
    .shoe.pointe{
      top:172px;
      left:52%;
      transform:translateX(-50%);
    }

    .leg.back{
      height:34px;
      top:140px;
      left:66%;
      transform:rotate(22deg);
      opacity:0.95;
    }
    .shoe.backShoe{
      top:170px;
      left:73%;
      transform:rotate(18deg);
      opacity:0.95;
    }

    /* controls */
    .controls{
      position:absolute;
      left:0; right:0;
      top:50%;
      transform:translateY(-15%);
      display:flex;
      justify-content:space-between;
      padding: 0 18px;
      pointer-events:none; /* only buttons receive */
    }
    .btnArrow{
      pointer-events:auto;
      width:64px;height:64px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.30);
      background: rgba(255,255,255,0.16);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:28px;
      font-weight:900;
      color:#2a1040;
      box-shadow: 0 14px 30px rgba(0,0,0,0.12);
      user-select:none;
    }
    .btnArrow:active{ transform: translateY(1px) scale(0.98); }

    /* balance meter */
    .meterWrap{
      position:absolute;
      left:50%;
      bottom: 18px;
      transform:translateX(-50%);
      width: min(86%, 380px);
      height: 14px;
      border-radius: 999px;
      background: rgba(0,0,0,0.12);
      border: 1px solid rgba(255,255,255,0.22);
      overflow:hidden;
    }
    .meterCenter{
      position:absolute;
      left:50%;
      top:0;
      width:2px;
      height:100%;
      background: rgba(255,255,255,0.55);
    }
    .meterFill{
      position:absolute;
      left:0; top:0; bottom:0;
      width:100%;
      background: linear-gradient(90deg,
        rgba(255, 86, 136, 0.35) 0%,
        rgba(255, 210, 120, 0.35) 50%,
        rgba(106, 255, 190, 0.35) 100%);
      opacity:0.7;
    }
    .meterDot{
      position:absolute;
      top:50%;
      transform:translate(-50%,-50%);
      width:18px;height:18px;
      border-radius:999px;
      background: var(--pink);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
      border: 2px solid rgba(255,255,255,0.70);
      left:50%;
    }

    .hint{
      padding: 0 16px 14px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    /* timer pill */
    .timeStrong{ font-variant-numeric: tabular-nums; }

    /* fail flash */
    .flash{
      position:absolute;
      inset:0;
      background: rgba(255, 64, 120, 0.14);
      opacity:0;
      pointer-events:none;
    }
    .flash.on{ opacity:1; transition: opacity 120ms ease; }
    .shake{
      animation: shake 220ms linear 1;
    }
    @keyframes shake{
      0%,100%{ transform:translateX(-50%) rotate(0deg); }
      20%{ transform:translateX(calc(-50% - 2px)) rotate(-2deg); }
      40%{ transform:translateX(calc(-50% + 2px)) rotate(2deg); }
      60%{ transform:translateX(calc(-50% - 2px)) rotate(-2deg); }
      80%{ transform:translateX(calc(-50% + 2px)) rotate(2deg); }
    }

    /* win overlay */
    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,0.22);
      backdrop-filter: blur(6px);
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(380px, 92%);
      border-radius:18px;
      padding:14px 14px 12px;
      background: rgba(255,255,255,0.14);
      border:1px solid rgba(255,255,255,0.22);
      box-shadow: 0 30px 80px rgba(0,0,0,0.35);
      text-align:center;
    }
    .modal h2{
      margin: 2px 0 6px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing:-0.01em;
    }
    .modal p{
      margin: 0 0 12px;
      color: rgba(255,255,255,0.86);
      font-size: 13px;
      line-height: 1.35;
    }
    .btn{
      appearance:none;
      border:0;
      border-radius:999px;
      padding: 12px 14px;
      width:100%;
      font-weight:900;
      letter-spacing:0.2px;
      background: linear-gradient(180deg, rgba(255, 200, 230, 0.30), rgba(255, 200, 230, 0.16));
      border:1px solid rgba(255,255,255,0.24);
      color:#fff;
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }

    /* confetti */
    canvas#confetti{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="header">
      <h1>Welcome to the Waterloo ballet studio! ü©∞</h1>
      <p class="sub">Tap left or right to balance your piqu√© pose.</p>
    </div>

    <div class="hud">
      <div class="pill">‚è±Ô∏è <span class="timeStrong"><strong id="timeLeft">10.0</strong></span>&nbsp;<small>s left</small></div>
      <div class="pill">‚öñÔ∏è <span>Balance:&nbsp;<strong id="statusTxt">steady</strong></span></div>
    </div>

    <div class="stage">
      <div class="frame">
        <div class="arena" id="arena">

          <div class="barre"></div>
          <div class="floor"></div>

          <div class="avatar" id="avatar" aria-label="agy96 in piqu√© pose">
            <div class="hair"></div>
            <div class="face"></div>

            <div class="glasses">
              <div class="lens"></div>
              <div class="lens"></div>
              <div class="bridge"></div>
            </div>

            <div class="arm arcL"></div>
            <div class="arm arcR"></div>

            <div class="top"></div>
            <div class="tutu"></div>

            <div class="leg support"></div>
            <div class="shoe pointe"></div>

            <div class="leg back"></div>
            <div class="shoe backShoe"></div>
          </div>

          <div class="controls">
            <div class="btnArrow" id="leftBtn" aria-label="Left">‚¨ÖÔ∏è</div>
            <div class="btnArrow" id="rightBtn" aria-label="Right">‚û°Ô∏è</div>
          </div>

          <div class="meterWrap" aria-label="Balance meter">
            <div class="meterFill"></div>
            <div class="meterCenter"></div>
            <div class="meterDot" id="meterDot"></div>
          </div>

          <div class="flash" id="flash"></div>

          <canvas id="confetti" width="600" height="800"></canvas>

          <div class="overlay" id="winOverlay">
            <div class="modal">
              <h2>Congratulations! üéâ</h2>
              <p>You balanced with grace under pressure.</p>
              <button class="btn" id="nextBtn">On to my next mission!</button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="hint">Hold it for 10 seconds. Small wobble ‚Üí tilt ‚Üí drop ‚Üí auto restart.</div>

  </div>
</div>

<!-- BGM (starts on first user tap; keep looping) -->
<audio id="bgm" src="./arcade.mp3" preload="auto" loop></audio>

<script>
(() => {
  // ===== DOM =====
  const bgm = document.getElementById("bgm");
  const arena = document.getElementById("arena");
  const avatar = document.getElementById("avatar");
  const meterDot = document.getElementById("meterDot");
  const timeLeftEl = document.getElementById("timeLeft");
  const statusTxt = document.getElementById("statusTxt");
  const leftBtn = document.getElementById("leftBtn");
  const rightBtn = document.getElementById("rightBtn");
  const flash = document.getElementById("flash");
  const winOverlay = document.getElementById("winOverlay");
  const nextBtn = document.getElementById("nextBtn");

  // confetti canvas
  const conf = document.getElementById("confetti");
  const cctx = conf.getContext("2d");

  // ===== Resize confetti to arena =====
  function resizeConfetti(){
    const r = arena.getBoundingClientRect();
    conf.width = Math.max(1, Math.floor(r.width));
    conf.height = Math.max(1, Math.floor(r.height));
  }
  window.addEventListener("resize", resizeConfetti);

  // ===== BGM =====
  let bgmStarted = false;
  async function ensureBgm(){
    if (bgmStarted) return;
    try{
      bgm.volume = 0.55;
      await bgm.play();
      bgmStarted = true;
      localStorage.setItem("bgmPlaying","true");
    }catch(e){
      bgmStarted = false;
    }
  }
  // auto-attempt if already playing before
  if (localStorage.getItem("bgmPlaying")==="true"){
    // still needs a user gesture on iOS sometimes; we'll also call ensureBgm on first tap
    bgm.volume = 0.55;
    bgm.play().then(()=>bgmStarted=true).catch(()=>{});
  }

  // ===== GAME STATE =====
  const TARGET_MS = 10000; // 10s
  const FAIL_THRESHOLD = 1.00; // if |balance| >= 1 => fail
  const TILT_THRESHOLD = 0.70; // tilt visual
  const STEADY_THRESHOLD = 0.35;

  // Drift tuning: fast + jittery
  const DRIFT_BASE = 0.00095;    // base acceleration per ms (in balance units/ms^2)
  const DRIFT_JITTER = 0.00125;  // random accel component
  const TAP_FORCE = 0.060;       // impulse per tap (in balance units)
  const DAMPING = 0.00055;       // velocity damping per ms
  const SPRING = 0.00035;        // spring back to center per ms

  let running = true;
  let won = false;

  // balance is -1..1. 0 is centered.
  let balance = 0;
  let vel = 0;
  let driftDir = Math.random() < 0.5 ? -1 : 1;

  let elapsed = 0;
  let lastTs = 0;

  // ===== UI HELPERS =====
  function setStatus(){
    const a = Math.abs(balance);
    if (a < STEADY_THRESHOLD) statusTxt.textContent = "steady";
    else if (a < TILT_THRESHOLD) statusTxt.textContent = "wobble";
    else statusTxt.textContent = "tilt";
  }

  function updateMeter(){
    // clamp and map [-1,1] -> [0,100%]
    const cl = Math.max(-1, Math.min(1, balance));
    const pct = (cl * 0.5 + 0.5) * 100;
    meterDot.style.left = pct + "%";
  }

  function updateAvatarTilt(){
    // rotate proportional
    const cl = Math.max(-1, Math.min(1, balance));
    const deg = cl * 14; // max tilt
    avatar.style.transform = `translateX(-50%) rotate(${deg}deg)`;
  }

  function hardRestart(){
    running = true;
    won = false;
    elapsed = 0;
    balance = 0;
    vel = 0;
    driftDir = Math.random() < 0.5 ? -1 : 1;
    winOverlay.classList.remove("show");
    cctx.clearRect(0,0,conf.width, conf.height);
    timeLeftEl.textContent = "10.0";
    setStatus();
    updateMeter();
    updateAvatarTilt();
  }

  function fail(){
    // fail feedback
    flash.classList.add("on");
    avatar.classList.add("shake");
    setTimeout(()=>flash.classList.remove("on"), 120);
    setTimeout(()=>avatar.classList.remove("shake"), 240);
    // restart after short delay
    running = false;
    setTimeout(()=>hardRestart(), 520);
  }

  // ===== INPUT =====
  function tapLeft(){
    ensureBgm();
    if (!running || won) return;
    vel -= TAP_FORCE;
  }
  function tapRight(){
    ensureBgm();
    if (!running || won) return;
    vel += TAP_FORCE;
  }

  leftBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); tapLeft(); }, {passive:false});
  rightBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); tapRight(); }, {passive:false});

  // also allow tap anywhere on left/right half (nice on mobile)
  arena.addEventListener("pointerdown", (e)=>{
    ensureBgm();
    if (!running || won) return;
    const r = arena.getBoundingClientRect();
    const x = e.clientX - r.left;
    if (x < r.width/2) tapLeft(); else tapRight();
  });

  // ===== CONFETTI (chaotic overload) =====
  let confetti = [];
  function spawnConfettiBurst(){
    confetti = [];
    const N = 220; // overload
    for (let i=0;i<N;i++){
      confetti.push({
        x: Math.random()*conf.width,
        y: -20 - Math.random()*conf.height*0.2,
        vx: (Math.random()*2-1) * (2.2 + Math.random()*2.0),
        vy: (2.6 + Math.random()*4.2),
        r: 2 + Math.random()*5,
        rot: Math.random()*Math.PI,
        vr: (Math.random()*2-1)*0.20,
        a: 0.65 + Math.random()*0.35,
        life: 0,
        max: 1200 + Math.random()*800
      });
    }
  }

  function drawConfetti(dt){
    cctx.clearRect(0,0,conf.width, conf.height);
    for (const p of confetti){
      p.life += dt;
      p.x += p.vx * dt * 0.06;
      p.y += p.vy * dt * 0.08;
      p.rot += p.vr * dt * 0.04;
      // gravity
      p.vy += 0.008 * dt;
      // fade
      const fade = Math.max(0, 1 - (p.life / p.max));
      const alpha = p.a * fade;

      if (alpha <= 0) continue;

      cctx.save();
      cctx.globalAlpha = alpha;
      cctx.translate(p.x, p.y);
      cctx.rotate(p.rot);

      // bright random colors
      const hue = (p.life*0.06 + p.x*0.3) % 360;
      cctx.fillStyle = `hsl(${hue} 90% 65%)`;
      cctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);

      cctx.restore();
    }
    // prune
    confetti = confetti.filter(p => p.life < p.max && p.y < conf.height + 80);
  }

  // ===== WIN =====
  function win(){
    won = true;
    running = false;
    winOverlay.classList.add("show");
    spawnConfettiBurst();
  }

  nextBtn.addEventListener("click", ()=>{
    // IMPORTANT: return to map at STADIUM prompt
    localStorage.setItem("mapPromptIndex", "3"); // stadium question index
    window.location.href = "./map.html";         // change if your map filename differs
  });

  // ===== MAIN LOOP =====
  function loop(ts){
    if (!lastTs) lastTs = ts;
    const dt = Math.min(33, ts - lastTs);
    lastTs = ts;

    if (won){
      drawConfetti(dt);
      requestAnimationFrame(loop);
      return;
    }

    if (running){
      elapsed += dt;

      // time left
      const left = Math.max(0, (TARGET_MS - elapsed)/1000);
      timeLeftEl.textContent = left.toFixed(1);

      // drift direction changes (randomly) so it feels mean
      if (Math.random() < 0.010 * (dt/16)){
        driftDir *= -1;
      }

      // acceleration = base + jitter, pushes to a side
      const accel = driftDir * (DRIFT_BASE + Math.random()*DRIFT_JITTER);

      // integrate velocity + balance
      vel += accel * dt;

      // damping + spring toward center
      vel *= (1 - DAMPING * dt);
      vel += (-balance) * SPRING * dt;

      balance += vel;

      // UI
      setStatus();
      updateMeter();
      updateAvatarTilt();

      // FAIL CHECK (THIS is what you were missing)
      if (Math.abs(balance) >= FAIL_THRESHOLD){
        fail();
      }

      // WIN CHECK
      if (elapsed >= TARGET_MS){
        win();
      }
    } else {
      // if paused for fail animation, still paint confetti none
    }

    requestAnimationFrame(loop);
  }

  // ===== INIT =====
  resizeConfetti();
  setStatus();
  updateMeter();
  updateAvatarTilt();

  // start immediately (no Start button)
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
